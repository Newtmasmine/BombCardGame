<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¸å¼¹ç¿»ç‰Œæ¸¸æˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(0, 0, 30, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .page {
            padding: 30px;
            display: none;
        }
        
        .active {
            display: block;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 25px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            font-size: 2.5rem;
        }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(0, 10, 30, 0.7);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #1976d2;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, #2196f3, #1976d2);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: linear-gradient(to right, #1976d2, #0d47a1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* æ¸¸æˆé¡µé¢æ ·å¼ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: rgba(0, 20, 40, 0.7);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .round-bonus-display {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
            z-index: 10;
            display: none; /* éšè—æœ¬è½®å¥–é‡‘æ˜¾ç¤º */
        }
        
        /* é£é™©å€¼æç¤ºæ ·å¼ */
        .risk-indicator {
            position: absolute;
            top: -15px;
            right: 20px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 2.2rem;
            font-weight: bold;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            box-shadow: 0 10px 30px rgba(255, 68, 68, 0.6);
            border: 4px solid rgba(255, 255, 255, 0.4);
            animation: riskPulse 2.5s infinite;
            z-index: 10;
            text-align: center;
            min-width: 200px;
        }
        
        .risk-indicator .risk-label {
            font-size: 0.9rem;
            display: block;
            margin-bottom: 8px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .risk-indicator .risk-value {
            font-size: 3rem;
            display: block;
            letter-spacing: 1px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .risk-indicator.low-risk {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.6);
        }
        
        .risk-indicator.medium-risk {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            box-shadow: 0 10px 30px rgba(255, 152, 0, 0.6);
        }
        
        .risk-indicator.high-risk {
            background: linear-gradient(135deg, #f44336, #b71c1c);
            box-shadow: 0 10px 30px rgba(244, 67, 54, 0.6);
        }
        
        @keyframes riskPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(255, 68, 68, 0.6);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 15px 40px rgba(255, 68, 68, 0.8);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(255, 68, 68, 0.6);
            }
        }
        
        .round-bonus-display.positive {
            background: linear-gradient(135deg, #4caf50, #45a049);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }
        
        .round-bonus-display.negative {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: rgba(25, 118, 210, 0.3);
            padding: 12px 16px;
            border-radius: 10px;
            text-align: center;
            min-width: 100px;
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffcc00;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 800px;
            justify-content: center;
        }
        
        .card {
            aspect-ratio: 2/3;
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
            min-height: 100px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .card.flipped {
            background: linear-gradient(135deg, #fbc02d, #f57f17);
            transform: rotateY(180deg);
        }
        
        .card.bomb {
            background: linear-gradient(135deg, #f44336, #b71c1c);
        }
        
        .card.reward {
            background: linear-gradient(135deg, #4caf50, #1b5e20);
        }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }
        
        .card-front {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
        }
        
        .card-back {
            background: linear-gradient(135deg, #fbc02d, #f57f17);
            transform: rotateY(180deg);
        }
        
        .card-value {
            color: white;
            font-size: 16px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn-game {
            padding: 14px 30px;
            font-size: 18px;
            min-width: 180px;
        }
        
        .btn-stop {
            background: linear-gradient(to right, #f44336, #d32f2f);
        }
        
        .btn-stop:hover {
            background: linear-gradient(to right, #d32f2f, #b71c1c);
        }
        
        .message {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            min-height: 40px;
            color: #ffcc00;
        }
        
        /* ç®¡ç†å‘˜é¡µé¢æ ·å¼ */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .admin-stat {
            background: rgba(25, 118, 210, 0.2);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .admin-stat h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .admin-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffcc00;
        }
        
        .admin-label {
            font-size: 1.1rem;
            color: #90caf9;
            margin-top: 10px;
        }
        
        .admin-note {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 10px;
            color: #ffcc00;
            font-size: 1.1rem;
        }
        
        /* ç‰¹æ•ˆæ ·å¼ */
        .explosion-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: #ff4444;
            z-index: 1000;
            animation: explode 1.5s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes explode {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }
        
        .coin-effect {
            position: fixed;
            font-size: 30px;
            color: #ffd700;
            animation: coinFlyToTarget 1s ease-out forwards;
            pointer-events: none;
            z-index: 999;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        @keyframes coinFlyToTarget {
            0% {
                transform: translateY(0) translateX(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-50px) translateX(0) scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-120px) translateX(var(--target-x, 0)) scale(0.3) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* é‡‘å¸ç²’å­ç‰¹æ•ˆ */
        .coin-particle {
            position: fixed;
            font-size: 20px;
            color: #ffd700;
            animation: particleFloat 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 998;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }
        
        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) scale(0.5) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--particle-x, 0), var(--particle-y, 0)) scale(0) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* é—ªå…‰ç‰¹æ•ˆ */
        .sparkle-effect {
            position: fixed;
            width: 100px;
            height: 100px;
            animation: sparkle 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 997;
        }
        
        @keyframes sparkle {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
                opacity: 1;
                box-shadow: 0 0 30px 10px rgba(255, 215, 0, 0.8),
                           0 0 60px 20px rgba(255, 215, 0, 0.4);
            }
            100% {
                transform: translate(-50%, -50%) scale(2) rotate(360deg);
                opacity: 0;
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }
        
        /* å…‰ç¯ç‰¹æ•ˆ */
        .reward-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            animation: glowPulse 1s ease-out;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes glowPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.8);
            }
            50% {
                box-shadow: 0 0 30px 15px rgba(255, 215, 0, 0.6),
                           0 0 60px 30px rgba(255, 215, 0, 0.3);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }
        
        .number-roll {
            animation: rollUp 0.5s ease-out;
        }
        
        .number-fall {
            animation: rollDown 0.5s ease-out;
        }
        
        @keyframes rollUp {
            0% {
                transform: translateY(30px) scale(0.8);
                opacity: 0;
                color: #ffd700;
                text-shadow: 0 0 20px rgba(255, 215, 0, 1);
            }
            50% {
                transform: translateY(-10px) scale(1.2);
                opacity: 1;
                text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
                text-shadow: none;
            }
        }
        
        @keyframes rollDown {
            0% {
                transform: translateY(-20px);
                opacity: 1;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .dialog-content {
            background: rgba(0, 20, 40, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .dialog-content h3 {
            color: #ffcc00;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .dialog-content p {
            color: #fff;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .dialog-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dialog-btn.confirm {
            background: linear-gradient(to right, #f44336, #d32f2f);
            color: white;
        }
        
        .dialog-btn.cancel {
            background: linear-gradient(to right, #2196f3, #1976d2);
            color: white;
        }
        
        .dialog-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* è½®æ¬¡ç‰¹æ•ˆæ ·å¼ */
        .round-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: bold;
            color: #ffcc00;
            z-index: 1000;
            animation: roundShow 2s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
        }
        
        @keyframes roundShow {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            30% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
            70% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }
        
        /* ç”¨æˆ·æ•°æ®è¡¨æ ¼æ ·å¼ */
        .user-data-section {
            margin: 30px 0;
        }
        
        .user-data-table {
            background: rgba(0, 20, 40, 0.7);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1.5fr 1fr;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(25, 118, 210, 0.3);
            font-weight: bold;
            color: #4fc3f7;
            font-size: 0.9rem;
        }
        
        .table-body {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .user-row {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1.5fr 1fr;
            gap: 10px;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            transition: background-color 0.3s ease;
            font-size: 0.9rem;
        }
        
        .user-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .user-row:last-child {
            border-bottom: none;
        }
        
        .user-detail-row {
            grid-column: 1 / -1;
            padding: 20px;
            background: rgba(0, 40, 80, 0.5);
            border-left: 3px solid #4fc3f7;
            margin: 0 20px 10px 20px;
            border-radius: 8px;
            display: none;
        }
        
        .user-detail-row.expanded {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-detail-content {
            color: #e0e0e0;
            line-height: 1.8;
        }
        
        .user-detail-content h4 {
            color: #4fc3f7;
            margin: 15px 0 10px 0;
            font-size: 1.1rem;
        }
        
        .user-detail-content p {
            margin: 5px 0;
        }
        
        .session-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 2px solid #66bb6a;
        }
        
        .round-detail {
            margin-left: 20px;
            padding: 5px 0;
            color: #b0b0b0;
            font-size: 0.9rem;
        }
        
        .btn-small {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            background: linear-gradient(to right, #2196f3, #1976d2);
            color: white;
        }
        
        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn-small.btn-danger {
            background: linear-gradient(to right, #f44336, #d32f2f);
        }
        
        .btn-small.btn-danger:hover {
            background: linear-gradient(to right, #d32f2f, #b71c1c);
        }
        
        .delete-user-btn {
            padding: 5px 10px;
            background: linear-gradient(to right, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .delete-user-btn:hover {
            background: linear-gradient(to right, #d32f2f, #b71c1c);
            transform: translateY(-1px);
        }
        
        /* æ¸¸æˆè§„åˆ™é¡µé¢æ ·å¼ */
        .rules-content {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 20, 40, 0.7);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .rules-section {
            margin-bottom: 30px;
        }
        
        .rules-section h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rules-section p, .rules-section li {
            color: #fff;
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .rules-section ul {
            padding-left: 20px;
        }
        
        .highlight {
            color: #ff4444;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
        }
        
        /* åŸºé‡‘å¥–åŠ±ç‰¹æ•ˆæ ·å¼ */
        .fund-bonus-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ff8f00);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            z-index: 2000;
            text-align: center;
            animation: fundBonusShow 3s ease-out forwards;
            pointer-events: none;
        }
        
        .fund-bonus-effect h2 {
            color: #1a1a1a;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .fund-bonus-effect .amount {
            font-size: 4rem;
            font-weight: bold;
            color: #d32f2f;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }
        
        .fund-bonus-effect p {
            color: #424242;
            font-size: 1.2rem;
        }
        
        @keyframes fundBonusShow {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }
        
        /* æƒ©ç½šç‰¹æ•ˆæ ·å¼ */
        .penalty-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff4444, #d32f2f);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
            z-index: 2000;
            text-align: center;
            animation: penaltyShow 2.5s ease-out forwards;
            pointer-events: none;
        }
        
        .penalty-effect h2 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .penalty-effect .amount {
            font-size: 3.5rem;
            font-weight: bold;
            color: #ffff8d;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }
        
        .penalty-effect p {
            color: #ffcccb;
            font-size: 1.2rem;
        }
        
        @keyframes penaltyShow {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(4, 1fr);
                max-width: 400px;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-box {
                min-width: auto;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .btn-game {
                width: 100%;
                max-width: 300px;
            }
            
            .table-header, .user-row {
                grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
                font-size: 12px;
            }
            
            .table-header div:nth-child(n+6),
            .user-row div:nth-child(n+6) {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .game-board {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .stats {
                gap: 8px;
            }
            
            .stat-box {
                padding: 10px 12px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .card {
                min-height: 60px;
                font-size: 1rem;
            }
            
            .card-value {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¡µé¢ -->
        <div id="login-page" class="page active">
            <h1>ç‚¸å¼¹ç¿»ç‰Œæ¸¸æˆ</h1>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group" id="confirm-password-group" style="display: none;">
                    <label for="confirm-password">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <div id="error-message" style="color: #ff4444; text-align: center; margin: 10px 0; min-height: 20px;"></div>
                <button id="login-btn" class="btn">ç™»å½•æ¸¸æˆ</button>
                <button id="register-btn" class="btn" style="background: linear-gradient(to right, #4caf50, #388e3c); margin-top: 15px;">
                    æ³¨å†Œè´¦å·
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆè§„åˆ™ä»‹ç»é¡µé¢ -->
        <div id="rules-page" class="page">
            <h1>æ¸¸æˆè§„åˆ™ä»‹ç»</h1>
            <div class="rules-content">
                <div class="rules-section">
                    <h2>ğŸ¯ æ¸¸æˆç›®æ ‡</h2>
                    <p>åœ¨ç¿»ç‰Œæ¸¸æˆä¸­è·å¾—å°½å¯èƒ½å¤šçš„å¥–é‡‘ï¼ŒåŒæ—¶é¿å…è§¦ç¢°ç‚¸å¼¹ã€‚</p>
                </div>
                
                <div class="rules-section">
                    <h2>ğŸƒ æ¸¸æˆè§„åˆ™</h2>
                    <ul>
                        <li><strong>æ¸¸æˆè½®æ•°ï¼š</strong>æ€»å…±9è½®æ¸¸æˆï¼ˆ3è½®ä½é£é™©ã€3è½®ä¸­é£é™©ã€3è½®é«˜é£é™©ï¼Œéšæœºåˆ†å¸ƒï¼‰</li>
                        <li><strong>å¡ç‰‡è®¾ç½®ï¼š</strong>æ¯è½®å›ºå®šæœ‰16å¼ å¡ç‰‡</li>
                        <li><strong>å¥–åŠ±å¡ï¼š</strong>å›ºå®šè·å¾—ç§¯åˆ†500</li>
                        <li><strong>ç‚¸å¼¹å¡ï¼š</strong>å›ºå®šæ‰£é™¤ç§¯åˆ†850</li>
                        <li><strong>å¥–é‡‘ç´¯ç§¯ï¼š</strong>æ¯è½®æˆåŠŸè·å¾—çš„å¥–é‡‘ä¼šç´¯åŠ åˆ°æ€»å¥–é‡‘ä¸­</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h2>ğŸ’£ ç‚¸å¼¹æœºåˆ¶</h2>
                    <ul>
                        <li>è§¦ç¢°åˆ°ç‚¸å¼¹å°†<span class="highlight">å›ºå®šæ‰£é™¤ç§¯åˆ†850</span></li>
                        <li>ç‚¸å¼¹æ•°é‡æ ¹æ®é£é™©ç­‰çº§è€Œå®š</li>
                        <li>å¯ä»¥éšæ—¶é€‰æ‹©"ç»“æŸæœ¬è½®"æ¥ä¿æŠ¤å·²è·å¾—çš„å¥–é‡‘</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h2>ğŸ’° å¥–é‡‘è¯´æ˜</h2>
                    <ul>
                        <li><strong>å¥–é‡‘ä¿æŠ¤ï¼š</strong>ä¸»åŠ¨ç»“æŸæœ¬è½®å¯ä¿ç•™å½“è½®å¥–é‡‘</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h2>ğŸ® æ“ä½œè¯´æ˜</h2>
                    <ul>
                        <li>ç‚¹å‡»å¡ç‰‡è¿›è¡Œç¿»ç‰Œ</li>
                        <li>éšæ—¶å¯ä»¥ç‚¹å‡»"ç»“æŸæœ¬è½®"ä»¥ç»“æŸå½“å‰è½®æ¬¡</li>
                        <li>å®Œæˆæœ¬è½®16å¼ å¡ç‰Œåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€è½®</li>
                        <li>å®Œæˆå…¨éƒ¨9è½®æ¸¸æˆåæ¸¸æˆç»“æŸ</li>
                    </ul>
                </div>
            </div>
            
            <div class="controls">
                <button id="exit-to-login-btn" class="btn btn-game" style="background: linear-gradient(to right, #9e9e9e, #616161);">
                    é€€å‡ºæ¸¸æˆ
                </button>
                <button id="enter-game-btn" class="btn btn-game" style="background: linear-gradient(to right, #4caf50, #388e3c);">
                    è¿›å…¥æ¸¸æˆ
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆé¡µé¢ -->
        <div id="game-page" class="page">
            <h1>ç‚¸å¼¹ç¿»ç‰ŒæŒ‘æˆ˜</h1>
            <div class="game-header">
                <div class="round-bonus-display" id="round-bonus-display">
                    æœ¬è½®: ç§¯åˆ†0
                </div>
                <div class="risk-indicator" id="risk-indicator">
                    <span class="risk-label">âš ï¸ é£é™©å€¼ âš ï¸</span>
                    <span class="risk-value">0.00%</span>
                </div>
                <div class="stats">
                    <div class="stat-box">
                        <div>ç´¯ç§¯è·å¾—</div>
                        <div id="total-bonus" class="stat-value">ç§¯åˆ†0</div>
                    </div>
                    <div class="stat-box" style="display: none;">
                        <div>æœ¬è½®å¥–é‡‘</div>
                        <div id="current-bonus" class="stat-value">ç§¯åˆ†0</div>
                    </div>
                    <div class="stat-box">
                        <div>å·²ç¿»ç‰Œæ•°</div>
                        <div id="flipped-count" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div>å‰©ä½™ç‰Œæ•°</div>
                        <div id="remaining-cards" class="stat-value">16</div>
                    </div>
                </div>
            </div>
            
            <div class="message" id="game-message">ç‚¹å‡»å¡ç‰‡å¼€å§‹æ¸¸æˆï¼</div>
            
            <div class="game-board" id="game-board">
                <!-- å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="controls">
                <button id="start-game-btn" class="btn btn-game" style="background: linear-gradient(to right, #4caf50, #388e3c);">å¼€å§‹æ¸¸æˆ</button>
                <button id="stop-round-btn" class="btn btn-game btn-stop" style="display: none;">ç»“æŸæœ¬è½®</button>
                <button id="exit-game-btn" class="btn btn-game" style="background: linear-gradient(to right, #9e9e9e, #616161);">é€€å‡ºæ¸¸æˆ</button>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜é¡µé¢ -->
        <div id="admin-page" class="page">
            <h1>æ¸¸æˆæ•°æ®ç»Ÿè®¡</h1>
            
            <div class="admin-note">
                æ­¤é¡µé¢ä»…ç®¡ç†å‘˜å¯è§ï¼Œæ˜¾ç¤ºæ¸¸æˆå…¨å±€ç»Ÿè®¡æ•°æ®
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat">
                    <h3>å¹³å‡ç¿»ç‰Œæ€»æ¬¡æ•°</h3>
                    <div id="avg-total-flips" class="admin-value">0</div>
                    <div class="admin-label">æ‰€æœ‰ç©å®¶çš„å¹³å‡ç¿»ç‰Œæ€»æ¬¡æ•°</div>
                </div>
                
                <div class="admin-stat">
                    <h3>å¹³å‡æå‰é€€å‡ºç‡</h3>
                    <div id="avg-early-exit-rate" class="admin-value">0%</div>
                    <div class="admin-label">æ‰€æœ‰ç©å®¶çš„å¹³å‡æå‰é€€å‡ºç‡</div>
                </div>
            </div>
            
            <!-- ç”¨æˆ·è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
            <div class="user-data-section">
                <h2 style="color: #4fc3f7; margin: 30px 0 20px 0;">ç”¨æˆ·è¯¦ç»†æ•°æ®</h2>
                <div class="user-data-table">
                    <div class="table-header">
                        <div>ç”¨æˆ·å</div>
                        <div>æ¸¸æˆæ€»æ—¶é•¿</div>
                        <div>ç¿»ç‰Œæ€»æ•°</div>
                        <div>æå‰é€€å‡ºç‡</div>
                        <div>å¹³å‡ç¿»ç‰Œæ¬¡æ•°</div>
                        <div>å½“å‰æ¸¸æˆè¿›åº¦</div>
                        <div>æ“ä½œ</div>
                    </div>
                    <div id="user-data-list" class="table-body">
                        <!-- ç”¨æˆ·æ•°æ®å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button id="export-data-btn" class="btn btn-game" style="background: linear-gradient(to right, #4caf50, #388e3c);">
                    ğŸ“¥ å¯¼å‡ºæ•°æ®åˆ°Excel
                </button>
                <button id="clear-all-data-btn" class="btn btn-game" style="background: linear-gradient(to right, #ff5722, #d84315);">
                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                </button>
                <button id="logout-btn" class="btn btn-game" style="background: linear-gradient(to right, #f44336, #d32f2f);">
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirm-dialog" class="confirm-dialog" style="display: none;">
        <div class="dialog-content">
            <h3>ç¡®è®¤é€€å‡ºæœ¬è½®ï¼Ÿ</h3>
            <p id="remaining-reward-text"></p>
            <div class="dialog-buttons">
                <button id="dialog-cancel" class="dialog-btn cancel">ç»§ç»­æ¸¸æˆ</button>
                <button id="dialog-confirm" class="dialog-btn confirm">ç¡®å®šé€€å‡º</button>
            </div>
        </div>
    </div>

    <!-- ä»˜è´¹ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="payment-dialog" class="confirm-dialog" style="display: none;">
        <div class="dialog-content">
            <h3>å¼€å§‹æ–°æ¸¸æˆ</h3>
            <p id="payment-text">æœ¬è½®æ¸¸æˆéœ€è¦æ”¯ä»˜ç§¯åˆ†200ï¼Œç¡®å®šå¼€å§‹å—ï¼Ÿ</p>
            <p style="color: #4fc3f7; font-size: 0.9rem; margin-top: 10px;">ç´¯ç§¯è·å¾—ï¼š<span id="current-balance">ç§¯åˆ†0</span></p>
            <div class="dialog-buttons">
                <button id="payment-cancel" class="dialog-btn cancel">å–æ¶ˆ</button>
                <button id="payment-confirm" class="dialog-btn confirm">ç¡®å®šæ”¯ä»˜</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®
        const gameData = {
            // å¡ç‰‡é…ç½®
            cards: [],
            rewardValue: 500, // å›ºå®šå¥–åŠ±é‡‘é¢
            bombPenalty: 850, // å›ºå®šç‚¸å¼¹æƒ©ç½šé‡‘é¢
            bombCount: 0, // å°†åœ¨æ¸¸æˆå¼€å§‹æ—¶éšæœºç”Ÿæˆ
            
            // è½®æ¬¡é…ç½®
            totalRounds: 9, // æ€»å…±9è½®
            currentRound: 0, // å½“å‰è½®æ¬¡ï¼ˆ1-9ï¼‰
            roundTypes: [], // å­˜å‚¨æ¯è½®çš„é£é™©ç±»å‹
            riskLevels: {
                low: { bombs: 4, rewards: 12 },    // ä½é£é™©ï¼š4ç‚¸å¼¹ï¼Œ12å¥–åŠ±
                medium: { bombs: 6, rewards: 10 }, // ä¸­é£é™©ï¼š6ç‚¸å¼¹ï¼Œ10å¥–åŠ±
                high: { bombs: 8, rewards: 8 }     // é«˜é£é™©ï¼š8ç‚¸å¼¹ï¼Œ8å¥–åŠ±
            },
            
            // æ¸¸æˆçŠ¶æ€
            totalBonus: 0, // ç´¯ç§¯è·å¾—ï¼ˆä»…åœ¨æ¯è½®ç»“æŸåæ›´æ–°ï¼‰
            currentRoundBonus: 0, // æœ¬è½®å¥–é‡‘ï¼ˆå¯ä¸ºè´Ÿæ•°ï¼‰
            flippedCount: 0,
            gameActive: false,
            roundEnded: false,
            currentPlayerSession: null,
            currentGameSession: null, // å½“å‰9è½®æ¸¸æˆçš„æ€»ä¼šè¯
            currentUser: null,
            isRegistering: false,
            
            // ç”¨æˆ·ç³»ç»Ÿ
            users: JSON.parse(localStorage.getItem('cardGameUsers') || '{}'),
            
            // ç»Ÿè®¡æ•°æ®ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰
            stats: {
                totalFlips: 0,
                gamesPlayed: 0,
                roundsPlayed: 0,
                earlyExits: 0,
                bombTriggers: 0,
                totalPossibleReward: 0,
                totalActualReward: 0,
                riskEstimations: [],
                averageCardsFlippedPerRound: 0
            },
            
            // ç©å®¶ä¼šè¯æ•°æ®
            playerSessions: JSON.parse(localStorage.getItem('cardGameSessions') || '[]')
        };
        
        // DOMå…ƒç´ 
        const loginPage = document.getElementById('login-page');
        const rulesPage = document.getElementById('rules-page');
        const gamePage = document.getElementById('game-page');
        const adminPage = document.getElementById('admin-page');
        const gameBoard = document.getElementById('game-board');
        const totalBonusEl = document.getElementById('total-bonus');
        const currentBonusEl = document.getElementById('current-bonus');
        const flippedCountEl = document.getElementById('flipped-count');
        const remainingCardsEl = document.getElementById('remaining-cards');
        const gameMessageEl = document.getElementById('game-message');
        
        // ç®¡ç†å‘˜æ•°æ®å…ƒç´ 
        const avgTotalFlipsEl = document.getElementById('avg-total-flips');
        const avgEarlyExitRateEl = document.getElementById('avg-early-exit-rate');
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            const userData = gameData.users[gameData.currentUser];
            
            // ç¡®ä¿ç”¨æˆ·æœ‰æ¸¸æˆè¿›åº¦æ•°æ®ç»“æ„
            if (!userData.gameProgress) {
                userData.gameProgress = {
                    currentRound: 0,
                    totalBonus: 0,
                    roundTypes: [],
                    isGameCompleted: false,
                    currentGameSession: null, // å½“å‰9è½®æ¸¸æˆçš„æ€»ä¼šè¯
                    allGameSessions: [] // æ‰€æœ‰å®Œæˆçš„9è½®æ¸¸æˆä¼šè¯
                };
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å®Œæˆ9è½®æ¸¸æˆ
            if (userData.gameProgress.isGameCompleted) {
                gameData.currentRound = 9;
                gameData.totalBonus = userData.gameProgress.totalBonus;
                showGameReadyState();
                return;
            }
            
            // åŠ è½½æˆ–åˆ›å»ºå½“å‰9è½®æ¸¸æˆçš„æ€»ä¼šè¯
            if (userData.gameProgress.currentGameSession) {
                // æ¢å¤ç°æœ‰çš„9è½®æ¸¸æˆä¼šè¯
                gameData.currentGameSession = userData.gameProgress.currentGameSession;
            } else {
                // åˆ›å»ºæ–°çš„9è½®æ¸¸æˆä¼šè¯
                gameData.currentGameSession = {
                    username: gameData.currentUser,
                    gameStartTime: Date.now(),
                    rounds: [], // å­˜å‚¨9è½®çš„è¯¦ç»†æ•°æ®
                    totalFlips: 0,
                    totalBombHits: 0,
                    finalReward: 0,
                    firstBombEncountered: false,
                    firstBombRound: null,
                    firstBombFlipCount: null,
                    flipsAfterFirstBomb: 0,
                    isCompleted: false
                };
                userData.gameProgress.currentGameSession = gameData.currentGameSession;
            }
            
            // åŒæ­¥currentPlayerSessionç”¨äºå½“å‰è½®æ¬¡
            gameData.currentPlayerSession = gameData.currentGameSession;
            
            // åŠ è½½æˆ–åˆå§‹åŒ–è½®æ¬¡ç±»å‹
            if (userData.gameProgress.roundTypes.length === 0) {
                // åˆå§‹åŒ–9è½®æ¸¸æˆçš„é£é™©ç±»å‹ï¼ˆ3è½®ä½é£é™©ã€3è½®ä¸­é£é™©ã€3è½®é«˜é£é™©ï¼Œéšæœºåˆ†å¸ƒï¼‰
                initializeRoundTypes();
                userData.gameProgress.roundTypes = gameData.roundTypes;
            } else {
                // åŠ è½½å·²ä¿å­˜çš„è½®æ¬¡ç±»å‹
                gameData.roundTypes = userData.gameProgress.roundTypes;
            }
            
            // åŠ è½½å½“å‰è½®æ¬¡å’Œä½™é¢
            gameData.currentRound = userData.gameProgress.currentRound;
            gameData.totalBonus = userData.gameProgress.totalBonus;
            
            // åŒæ­¥åˆ°ç”¨æˆ·ç»Ÿè®¡
            userData.stats.totalRewards = gameData.totalBonus;
            
            // ä¿å­˜è¿›åº¦
            saveUserData();
            
            // æ˜¾ç¤ºæ¸¸æˆå‡†å¤‡çŠ¶æ€
            showGameReadyState();
        }
        
        // åˆå§‹åŒ–è½®æ¬¡é£é™©ç±»å‹
        function initializeRoundTypes() {
            // åˆ›å»º3è½®ä½é£é™©ã€3è½®ä¸­é£é™©ã€3è½®é«˜é£é™©çš„æ•°ç»„
            const types = [
                'low', 'low', 'low',
                'medium', 'medium', 'medium',
                'high', 'high', 'high'
            ];
            
            // éšæœºæ‰“ä¹±é¡ºåº
            gameData.roundTypes = shuffleArray(types);
        }
        
        // æ•°ç»„éšæœºæ‰“ä¹±å‡½æ•°
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // æ˜¾ç¤ºæ¸¸æˆå‡†å¤‡çŠ¶æ€
        function showGameReadyState() {
            // ç¡®ä¿åŠ è½½ç”¨æˆ·ç´¯ç§¯è·å¾—
            if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                const userData = gameData.users[gameData.currentUser];
                if (userData.gameProgress) {
                    gameData.totalBonus = userData.gameProgress.totalBonus;
                } else {
                    gameData.totalBonus = userData.stats.totalRewards || 0;
                }
            }
            
            // æ›´æ–°ä½™é¢æ˜¾ç¤ºï¼ˆæ”¯æŒè´Ÿæ•°ï¼‰
            const displayTotalBonus = gameData.totalBonus >= 0 ? 
                `ç§¯åˆ†${gameData.totalBonus.toLocaleString()}` : 
                `-ç§¯åˆ†${Math.abs(gameData.totalBonus).toLocaleString()}`;
            totalBonusEl.textContent = displayTotalBonus;
            currentBonusEl.textContent = 'ç§¯åˆ†0';
            flippedCountEl.textContent = '0';
            remainingCardsEl.textContent = '16';
            
            // æ˜¾ç¤ºå¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œéšè—ç»“æŸæœ¬è½®æŒ‰é’®
            document.getElementById('start-game-btn').style.display = 'inline-block';
            document.getElementById('stop-round-btn').style.display = 'none';
            
            // æ¸…ç©ºæ¸¸æˆåŒºåŸŸ
            gameBoard.innerHTML = '';
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²ç»“æŸï¼ˆ9è½®å®Œæˆï¼‰
            if (gameData.currentRound >= gameData.totalRounds) {
                gameMessageEl.textContent = 'ğŸ‰ æ­å–œå®Œæˆå…¨éƒ¨9è½®æ¸¸æˆï¼æœ€ç»ˆä½™é¢ï¼š' + displayTotalBonus;
                gameMessageEl.style.color = '#4caf50';
                document.getElementById('start-game-btn').style.display = 'none';
                
                // æ ‡è®°æ¸¸æˆå·²å®Œæˆ
                if (gameData.currentUser && gameData.users[gameData.currentUser].gameProgress) {
                    gameData.users[gameData.currentUser].gameProgress.isGameCompleted = true;
                    saveUserData();
                }
            } else {
                const nextRoundNum = gameData.currentRound + 1;
                const nextRiskType = gameData.roundTypes[gameData.currentRound];
                const riskText = nextRiskType === 'low' ? 'ä½é£é™©' : (nextRiskType === 'medium' ? 'ä¸­é£é™©' : 'é«˜é£é™©');
                gameMessageEl.textContent = `å‡†å¤‡å¼€å§‹ç¬¬${nextRoundNum}/9è½®ï¼ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"ç»§ç»­`;
                gameMessageEl.style.color = '#ffcc00';
            }
            
            // é‡ç½®æ¸¸æˆæ•°æ®
            gameData.gameActive = false;
            gameData.roundEnded = false;
            gameData.flippedCount = 0;
            gameData.currentRoundBonus = 0;
            
            // é‡ç½®æœ¬è½®å¥–é‡‘æ˜¾ç¤º
            updateRoundBonusDisplay();
            
            // éšè—é£é™©æŒ‡ç¤ºå™¨
            const riskIndicatorEl = document.getElementById('risk-indicator');
            if (riskIndicatorEl) {
                riskIndicatorEl.style.display = 'none';
            }
        }
        
        // å¼€å§‹æ–°ä¸€è½®æ¸¸æˆ
        function startNewRound() {
            // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ9è½®
            if (gameData.currentRound >= gameData.totalRounds) {
                alert('å·²å®Œæˆå…¨éƒ¨9è½®æ¸¸æˆï¼');
                return;
            }
            
            // å¢åŠ å½“å‰è½®æ¬¡
            gameData.currentRound++;
            
            // è®°å½•æœ¬è½®å¼€å§‹æ—¶é—´
            gameData.currentRoundStartTime = Date.now();
            
            gameData.currentRoundBonus = 0;
            gameData.flippedCount = 0;
            gameData.gameActive = true;
            gameData.roundEnded = false;
            
            // åˆå§‹åŒ–æœ¬è½®ç‚¸å¼¹è·Ÿè¸ªæ•°æ®
            gameData.currentRoundBombsTriggered = 0; // æœ¬è½®è§¦å‘çš„ç‚¸å¼¹æ•°é‡
            gameData.currentRoundFirstBombFlipped = false; // æœ¬è½®æ˜¯å¦è§¦å‘äº†ç¬¬ä¸€ä¸ªç‚¸å¼¹
            gameData.currentRoundFirstBombFlipCount = 0; // æœ¬è½®è§¦å‘ç¬¬ä¸€ä¸ªç‚¸å¼¹æ—¶çš„ç¿»ç‰Œæ•°
            gameData.currentRoundFlipsAfterFirstBomb = 0; // æœ¬è½®ç¬¬ä¸€ä¸ªç‚¸å¼¹åçš„ç¿»ç‰Œæ•°
            
            // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ - æ–°æ¸¸æˆå¼€å§‹
            if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                gameData.users[gameData.currentUser].stats.gamesPlayed++;
            }
            
            // æ›´æ–°UIï¼ˆç´¯ç§¯è·å¾—ä¸å˜ï¼Œåªé‡ç½®æœ¬è½®å¥–é‡‘ï¼‰
            const displayTotalBonus = gameData.totalBonus >= 0 ? 
                `ç§¯åˆ†${gameData.totalBonus.toLocaleString()}` : 
                `-ç§¯åˆ†${Math.abs(gameData.totalBonus).toLocaleString()}`;
            totalBonusEl.textContent = displayTotalBonus;
            currentBonusEl.textContent = 'ç§¯åˆ†0';
            flippedCountEl.textContent = '0';
            remainingCardsEl.textContent = '16';
            
            // è·å–å½“å‰è½®æ¬¡çš„é£é™©ç±»å‹
            const currentRiskType = gameData.roundTypes[gameData.currentRound - 1];
            const riskText = currentRiskType === 'low' ? 'ä½é£é™©' : (currentRiskType === 'medium' ? 'ä¸­é£é™©' : 'é«˜é£é™©');
            gameMessageEl.textContent = `ç¬¬${gameData.currentRound}/9è½®- ç‚¹å‡»å¡ç‰‡å¼€å§‹ç¿»ç‰Œï¼`;
            gameMessageEl.style.color = '#ffcc00';
            
            // æ˜¾ç¤ºç»“æŸæœ¬è½®æŒ‰é’®ï¼Œéšè—å¼€å§‹æ¸¸æˆæŒ‰é’®
            document.getElementById('start-game-btn').style.display = 'none';
            document.getElementById('stop-round-btn').style.display = 'inline-block';
            
            // æ˜¾ç¤ºé£é™©æŒ‡ç¤ºå™¨
            const riskIndicatorEl = document.getElementById('risk-indicator');
            if (riskIndicatorEl) {
                riskIndicatorEl.style.display = 'block';
            }
            
            // åˆå§‹åŒ–æœ¬è½®å¥–é‡‘æ˜¾ç¤º
            updateRoundBonusDisplay();
            
            // åˆ›å»ºå¡ç‰‡
            createCards();
        }
        
        // åˆ›å»ºå¡ç‰‡
        function createCards() {
            gameBoard.innerHTML = '';
            gameData.cards = [];
            
            // è·å–å½“å‰è½®æ¬¡çš„é£é™©ç±»å‹
            const currentRiskType = gameData.roundTypes[gameData.currentRound - 1];
            const riskConfig = gameData.riskLevels[currentRiskType];
            
            // æ ¹æ®é£é™©ç­‰çº§è®¾ç½®ç‚¸å¼¹å’Œå¥–åŠ±æ•°é‡
            gameData.bombCount = riskConfig.bombs;
            const rewardCount = riskConfig.rewards;
            
            // åˆ›å»ºç‚¸å¼¹å¡ç‰‡
            for (let i = 0; i < gameData.bombCount; i++) {
                gameData.cards.push({
                    type: 'bomb',
                    value: gameData.bombPenalty, // å›ºå®šæƒ©ç½š850å…ƒ
                    flipped: false
                });
            }
            
            // åˆ›å»ºå¥–åŠ±å¡ç‰‡
            for (let i = 0; i < rewardCount; i++) {
                gameData.cards.push({
                    type: 'reward',
                    value: gameData.rewardValue, // å›ºå®šå¥–åŠ±500å…ƒ
                    flipped: false
                });
            }
            
            // æ´—ç‰Œ
            shuffleCards();
            
            // æ¸²æŸ“å¡ç‰‡
            gameData.cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.innerHTML = `
                    <div class="card-front">?</div>
                    <div class="card-back">
                        <div class="card-value">${card.type === 'reward' ? 'ç§¯åˆ†' + card.value : 'ğŸ’£'}</div>
                    </div>
                `;
                
                cardEl.addEventListener('click', () => flipCard(index));
                gameBoard.appendChild(cardEl);
            });
            
            // æ›´æ–°å‰©ä½™å¡ç‰‡æ•°æ˜¾ç¤º
            remainingCardsEl.textContent = '16';
            
            // åˆå§‹åŒ–é£é™©å€¼æ˜¾ç¤º
            updateRiskIndicator();
        }
        
        // æ´—ç‰Œç®—æ³•
        function shuffleCards() {
            for (let i = gameData.cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gameData.cards[i], gameData.cards[j]] = [gameData.cards[j], gameData.cards[i]];
            }
        }
        
        // ç¿»ç‰Œ
        function flipCard(index) {
            if (!gameData.gameActive || gameData.roundEnded || gameData.cards[index].flipped) return;
            
            const card = gameData.cards[index];
            card.flipped = true;
            gameData.flippedCount++;
            
            // å¦‚æœæœ¬è½®å·²ç»è§¦å‘è¿‡ç¬¬ä¸€ä¸ªç‚¸å¼¹ï¼Œåˆ™è®°å½•æ­¤åçš„ç¿»ç‰Œæ¬¡æ•°
            if (gameData.currentRoundFirstBombFlipped) {
                gameData.currentRoundFlipsAfterFirstBomb++;
            }
            
            // å¦‚æœæ•´ä¸ªæ¸¸æˆä¼šè¯å·²ç»è§¦å‘è¿‡ç¬¬ä¸€ä¸ªç‚¸å¼¹ï¼Œåˆ™è®°å½•æ­¤åçš„ç¿»ç‰Œæ¬¡æ•°
            if (gameData.currentPlayerSession.firstBombEncountered) {
                gameData.currentPlayerSession.flipsAfterFirstBomb++;
            }
            
            // åªæ›´æ–°å½“å‰ç”¨æˆ·çš„æ¸¸æˆä¼šè¯æ•°æ®
            gameData.currentPlayerSession.totalFlips++;
            
            // æ›´æ–°ç”¨æˆ·ç¿»ç‰Œç»Ÿè®¡
            if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                gameData.users[gameData.currentUser].stats.totalFlips++;
            }
            
            // æ›´æ–°UI
            flippedCountEl.textContent = gameData.flippedCount;
            remainingCardsEl.textContent = 16 - gameData.flippedCount;
            
            const cardEl = gameBoard.children[index];
            cardEl.classList.add('flipped');
            
            // å¤„ç†å¡ç‰‡ç±»å‹
            if (card.type === 'reward') {
                cardEl.classList.add('reward');
                gameData.currentRoundBonus += card.value;
                
                // æ˜¾ç¤ºé‡‘å¸ç‰¹æ•ˆ
                showCoinEffect(cardEl);
                
                // å»¶è¿Ÿæ›´æ–°é‡‘é¢ä»¥é…åˆç‰¹æ•ˆ
                setTimeout(() => {
                    updateRoundBonusDisplay();
                    const displayBonus = gameData.currentRoundBonus >= 0 ? 
                        `ç§¯åˆ†${gameData.currentRoundBonus.toLocaleString()}` : 
                        `-ç§¯åˆ†${Math.abs(gameData.currentRoundBonus).toLocaleString()}`;
                    animateNumberRoll(currentBonusEl, displayBonus, true);
                }, 300);
                
                gameMessageEl.textContent = `æ­å–œï¼è·å¾— ç§¯åˆ†${card.value.toLocaleString()} å¥–åŠ±ï¼`;
                gameMessageEl.style.color = '#4caf50';
                
                // ä¸å†æ£€æŸ¥æ‰€æœ‰å¥–åŠ±å¡æ˜¯å¦ç¿»å®Œï¼Œåªåœ¨16å¼ å¡å…¨éƒ¨ç¿»å®Œæ—¶ç»“æŸ
            } else {
                cardEl.classList.add('bomb');
                
                // è®°å½•æœ¬è½®ç‚¸å¼¹è§¦å‘æ¬¡æ•°
                gameData.currentRoundBombsTriggered++;
                
                // è®°å½•æœ¬è½®æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è§¦å‘ç‚¸å¼¹
                if (!gameData.currentRoundFirstBombFlipped) {
                    gameData.currentRoundFirstBombFlipped = true;
                    gameData.currentRoundFirstBombFlipCount = gameData.flippedCount;
                }
                
                // è®°å½•æ•´ä¸ªæ¸¸æˆä¼šè¯æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è§¦å‘ç‚¸å¼¹
                if (!gameData.currentPlayerSession.firstBombEncountered) {
                    gameData.currentPlayerSession.firstBombEncountered = true;
                    gameData.currentPlayerSession.firstBombRound = gameData.currentRound;
                    gameData.currentPlayerSession.firstBombFlipCount = gameData.flippedCount;
                }
                
                // åªæ›´æ–°å½“å‰ç”¨æˆ·çš„æ¸¸æˆä¼šè¯æ•°æ®
                gameData.currentPlayerSession.totalBombHits++;
                
                // æ›´æ–°ç”¨æˆ·ç‚¸å¼¹è§¦å‘ç»Ÿè®¡
                if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                    gameData.users[gameData.currentUser].stats.bombTriggers++;
                }
                
                // å›ºå®šæ‰£é™¤850å…ƒ - ä»æœ¬è½®å¥–é‡‘ä¸­æ‰£é™¤ï¼Œå¯ä»¥ä¸ºè´Ÿæ•°
                const penaltyAmount = gameData.bombPenalty;
                gameData.currentRoundBonus -= penaltyAmount;
                
                // ç«‹å³æ›´æ–°æœ¬è½®å¥–é‡‘æ˜¾ç¤º
                updateRoundBonusDisplay();
                
                gameMessageEl.textContent = `ğŸ’£ ç‚¸å¼¹ï¼æ‰£é™¤ç§¯åˆ†${penaltyAmount.toLocaleString()}`;
                gameMessageEl.style.color = '#f44336';
            }
            
            // æ›´æ–°é£é™©å€¼æ˜¾ç¤ºï¼ˆæ¯æ¬¡ç¿»ç‰Œåï¼‰
            updateRiskIndicator();
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¡ç‰‡éƒ½å·²ç¿»å¼€
            const allCardsFlipped = gameData.cards.filter(c => !c.flipped).length === 0;
            
            if (allCardsFlipped) {
                setTimeout(() => {
                    // æ˜¾ç¤ºæœ¬è½®å¥–é‡‘æ¶ˆæ¯ï¼ˆå¯èƒ½ä¸ºè´Ÿæ•°ï¼‰
                    const displayRoundBonus = gameData.currentRoundBonus >= 0 ? 
                        `ç§¯åˆ†${gameData.currentRoundBonus.toLocaleString()}` : 
                        `-ç§¯åˆ†${Math.abs(gameData.currentRoundBonus).toLocaleString()}`;
                    
                    gameMessageEl.textContent = `ğŸŠ 16å¼ å¡ç‰Œå·²å…¨éƒ¨ç¿»å¼€ï¼æœ¬è½®å¥–é‡‘ï¼š${displayRoundBonus}`;
                    gameMessageEl.style.color = '#4caf50';
                    
                    // å°†æœ¬è½®å¥–é‡‘åŠ åˆ°ç´¯ç§¯è·å¾—ï¼ˆæœ¬è½®ç»“æŸæ—¶æ‰æ›´æ–°ç´¯ç§¯è·å¾—ï¼‰
                    gameData.totalBonus += gameData.currentRoundBonus;
                    
                    const displayTotalBonus = gameData.totalBonus >= 0 ? 
                        `ç§¯åˆ†${gameData.totalBonus.toLocaleString()}` : 
                        `-ç§¯åˆ†${Math.abs(gameData.totalBonus).toLocaleString()}`;
                    animateNumberRoll(totalBonusEl, displayTotalBonus, gameData.currentRoundBonus >= 0);
                    
                    // è®°å½•æœ¬è½®æ•°æ®åˆ°å½“å‰æ¸¸æˆä¼šè¯
                    const roundData = {
                        roundNumber: gameData.currentRound,
                        riskType: gameData.roundTypes[gameData.currentRound - 1],
                        flippedCards: gameData.flippedCount,
                        roundBonus: gameData.currentRoundBonus,
                        totalBonusAfter: gameData.totalBonus,
                        endReason: 'complete',
                        completedAt: Date.now(),
                        // æœ¬è½®ç‚¸å¼¹ç›¸å…³æ•°æ®
                        bombsTriggered: gameData.currentRoundBombsTriggered,
                        firstBombFlipped: gameData.currentRoundFirstBombFlipped,
                        firstBombFlipCount: gameData.currentRoundFirstBombFlipCount,
                        flipsAfterFirstBomb: gameData.currentRoundFlipsAfterFirstBomb,
                        // æ—¶é•¿æ•°æ®
                        startTime: gameData.currentRoundStartTime,
                        endTime: Date.now(),
                        durationSeconds: Math.round((Date.now() - gameData.currentRoundStartTime) / 1000)
                    };
                    
                    if (gameData.currentGameSession) {
                        gameData.currentGameSession.rounds.push(roundData);
                        gameData.currentGameSession.finalReward = gameData.totalBonus;
                    }
                    
                    // ä¿å­˜æ¸¸æˆæ•°æ®å’Œè¿›åº¦
                    if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                        const userData = gameData.users[gameData.currentUser];
                        userData.stats.totalRewards = gameData.totalBonus;
                        
                        // æ›´æ–°æ¸¸æˆè¿›åº¦ï¼šå½“å‰è½®æ¬¡å·²å®Œæˆ
                        if (userData.gameProgress) {
                            userData.gameProgress.currentRound = gameData.currentRound;
                            userData.gameProgress.totalBonus = gameData.totalBonus;
                            userData.gameProgress.currentGameSession = gameData.currentGameSession;
                            
                            // å¦‚æœå®Œæˆäº†9è½®ï¼Œæ ‡è®°ä¸ºå®Œæˆå¹¶ä¿å­˜åˆ°å†å²è®°å½•
                            if (gameData.currentRound >= 9) {
                                userData.gameProgress.isGameCompleted = true;
                                gameData.currentGameSession.isCompleted = true;
                                gameData.currentGameSession.gameEndTime = Date.now();
                                
                                // å°†å®Œæˆçš„æ¸¸æˆä¼šè¯ä¿å­˜åˆ°å†å²è®°å½•
                                if (!userData.gameProgress.allGameSessions) {
                                    userData.gameProgress.allGameSessions = [];
                                }
                                userData.gameProgress.allGameSessions.push({...gameData.currentGameSession});
                                
                                // åŒæ—¶ä¿å­˜åˆ°ç”¨æˆ·çš„sessionsæ•°ç»„ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
                                if (!userData.sessions) {
                                    userData.sessions = [];
                                }
                                userData.sessions.push({...gameData.currentGameSession});
                            }
                        }
                    }
                    
                    saveUserData();
                    
                    // å»¶è¿Ÿåè¿”å›å¼€å§‹æ¸¸æˆç•Œé¢
                    setTimeout(() => {
                        showGameReadyState();
                    }, 2000);
                }, 1000);
            }
            
            // è®°å½•é£é™©ä¼°è®¡æ•°æ®
            recordRiskEstimation();
        }
        
        // è®°å½•é£é™©ä¼°è®¡æ•°æ® - å±äºå½“å‰ç”¨æˆ·
        function recordRiskEstimation() {
            const remainingCards = gameData.cards.filter(c => !c.flipped);
            const remainingBombs = remainingCards.filter(c => c.type === 'bomb').length;
            const remainingRewards = remainingCards.filter(c => c.type === 'reward').length;
            
            if (remainingCards.length > 0 && gameData.currentUser && gameData.users[gameData.currentUser]) {
                const bombProbability = remainingBombs / remainingCards.length;
                
                // ç¡®ä¿ç”¨æˆ·æœ‰é£é™©ä¼°è®¡æ•°ç»„
                if (!gameData.users[gameData.currentUser].riskEstimations) {
                    gameData.users[gameData.currentUser].riskEstimations = [];
                }
                
                gameData.users[gameData.currentUser].riskEstimations.push({
                    actualBombProb: bombProbability,
                    flippedCount: gameData.flippedCount,
                    timestamp: Date.now()
                });
            }
        }
        
        // æ›´æ–°æœ¬è½®å¥–é‡‘æ˜¾ç¤º
        function updateRoundBonusDisplay() {
            const roundBonusEl = document.getElementById('round-bonus-display');
            if (!roundBonusEl) return;
            
            const displayBonus = gameData.currentRoundBonus >= 0 ? 
                `æœ¬è½®: +ç§¯åˆ†${gameData.currentRoundBonus.toLocaleString()}` : 
                `æœ¬è½®: -ç§¯åˆ†${Math.abs(gameData.currentRoundBonus).toLocaleString()}`;
            
            roundBonusEl.textContent = displayBonus;
            
            // æ ¹æ®æ­£è´Ÿå€¼æ”¹å˜æ ·å¼
            roundBonusEl.className = 'round-bonus-display';
            if (gameData.currentRoundBonus > 0) {
                roundBonusEl.classList.add('positive');
            } else if (gameData.currentRoundBonus < 0) {
                roundBonusEl.classList.add('negative');
            }
        }
        
        // æ›´æ–°é£é™©å€¼æ˜¾ç¤º
        function updateRiskIndicator() {
            const riskIndicatorEl = document.getElementById('risk-indicator');
            if (!riskIndicatorEl) return;
            
            // è®¡ç®—æœªç¿»å¼€çš„å¡ç‰Œ
            const remainingCards = gameData.cards.filter(c => !c.flipped);
            const remainingBombs = remainingCards.filter(c => c.type === 'bomb').length;
            const totalRemainingCards = remainingCards.length;
            
            // è®¡ç®—å³æ—¶é£é™©ï¼šæœªç¿»å¼€çš„ç‚¸å¼¹æ•°/æœªç¿»å¼€çš„å¡ç‰Œæ€»æ•°*100%
            let riskPercentage = 0;
            if (totalRemainingCards > 0) {
                riskPercentage = (remainingBombs / totalRemainingCards) * 100;
            }
            
            // å››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°
            riskPercentage = Math.round(riskPercentage * 100) / 100;
            
            // æ›´æ–°æ˜¾ç¤º
            const riskValueEl = riskIndicatorEl.querySelector('.risk-value');
            if (riskValueEl) {
                riskValueEl.textContent = `${riskPercentage.toFixed(2)}%`;
            }
            
            // æ ¹æ®é£é™©å€¼æ”¹å˜æ ·å¼ï¼ˆè°ƒæ•´é˜ˆå€¼ä»¥é€‚åº”æ–°çš„è®¡ç®—æ–¹å¼ï¼‰
            riskIndicatorEl.className = 'risk-indicator';
            if (riskPercentage < 30) {
                riskIndicatorEl.classList.add('low-risk');
            } else if (riskPercentage < 50) {
                riskIndicatorEl.classList.add('medium-risk');
            } else {
                riskIndicatorEl.classList.add('high-risk');
            }
        }
        
        // ç‰¹æ•ˆå‡½æ•°
        function showExplosionEffect() {
            const explosion = document.createElement('div');
            explosion.className = 'explosion-effect';
            explosion.innerHTML = 'ğŸ’¥';
            document.body.appendChild(explosion);
            
            setTimeout(() => {
                document.body.removeChild(explosion);
            }, 1500);
        }
        
        function showCoinEffect(startElement) {
            const startRect = startElement.getBoundingClientRect();
            const targetRect = currentBonusEl.getBoundingClientRect();
            const targetX = targetRect.left - startRect.left;
            
            // æ·»åŠ å¡ç‰‡å…‰ç¯ç‰¹æ•ˆ
            const glow = document.createElement('div');
            glow.className = 'reward-glow';
            startElement.appendChild(glow);
            setTimeout(() => {
                if (startElement.contains(glow)) {
                    startElement.removeChild(glow);
                }
            }, 1000);
            
            // åˆ›å»ºé—ªå…‰ç‰¹æ•ˆ
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle-effect';
            sparkle.style.left = startRect.left + startRect.width / 2 + 'px';
            sparkle.style.top = startRect.top + startRect.height / 2 + 'px';
            sparkle.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0.4) 30%, transparent 70%)';
            document.body.appendChild(sparkle);
            setTimeout(() => {
                if (document.body.contains(sparkle)) {
                    document.body.removeChild(sparkle);
                }
            }, 800);
            
            // åˆ›å»ºå¤šä¸ªä¸»é‡‘å¸
            for (let i = 0; i < 5; i++) {
                const coin = document.createElement('div');
                coin.className = 'coin-effect';
                coin.innerHTML = 'ğŸª™';
                
                // æ·»åŠ éšæœºå»¶è¿Ÿå’Œè½»å¾®åç§»
                const delay = i * 50;
                const randomOffset = (Math.random() - 0.5) * 40;
                
                coin.style.setProperty('--target-x', (targetX + randomOffset) + 'px');
                coin.style.left = startRect.left + startRect.width / 2 + 'px';
                coin.style.top = startRect.top + startRect.height / 2 + 'px';
                coin.style.animationDelay = delay + 'ms';
                
                document.body.appendChild(coin);
                
                setTimeout(() => {
                    if (document.body.contains(coin)) {
                        document.body.removeChild(coin);
                    }
                }, 1000 + delay);
            }
            
            // åˆ›å»ºé‡‘å¸ç²’å­çˆ†ç‚¸æ•ˆæœ
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'coin-particle';
                particle.innerHTML = Math.random() > 0.5 ? 'ğŸ’°' : 'âœ¨';
                
                // è®¡ç®—éšæœºæ–¹å‘
                const angle = (Math.PI * 2 * i) / 12;
                const distance = 100 + Math.random() * 50;
                const particleX = Math.cos(angle) * distance;
                const particleY = Math.sin(angle) * distance;
                
                particle.style.setProperty('--particle-x', particleX + 'px');
                particle.style.setProperty('--particle-y', particleY + 'px');
                particle.style.left = startRect.left + startRect.width / 2 + 'px';
                particle.style.top = startRect.top + startRect.height / 2 + 'px';
                particle.style.animationDelay = (i * 30) + 'ms';
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (document.body.contains(particle)) {
                        document.body.removeChild(particle);
                    }
                }, 1500 + i * 30);
            }
        }
        
        function animateNumberRoll(element, newValue, isIncrease = true) {
            element.classList.add(isIncrease ? 'number-roll' : 'number-fall');
            element.textContent = newValue;
            
            setTimeout(() => {
                element.classList.remove('number-roll', 'number-fall');
            }, 500);
        }
        
        function showConfirmDialog() {
            const remainingRewards = gameData.cards.filter(c => 
                c.type === 'reward' && !c.flipped);
            const totalRemaining = remainingRewards.reduce((sum, card) => sum + card.value, 0);
            
            document.getElementById('confirm-dialog').style.display = 'flex';
        }
        
        function hideConfirmDialog() {
            document.getElementById('confirm-dialog').style.display = 'none';
        }
        
        function showPaymentDialog() {
            document.getElementById('current-balance').textContent = `ç§¯åˆ†${gameData.totalBonus.toLocaleString()}`;
            
            if (gameData.totalBonus < gameData.roundCost) {
                document.getElementById('payment-text').textContent = 'ä½™é¢ä¸è¶³ï¼Œæ— æ³•å¼€å§‹æ¸¸æˆï¼';
                document.getElementById('payment-confirm').style.display = 'none';
            } else {
                document.getElementById('payment-text').textContent = `æœ¬è½®æ¸¸æˆéœ€è¦æ”¯ä»˜ç§¯åˆ†${gameData.roundCost}ï¼Œç¡®å®šå¼€å§‹å—ï¼Ÿ`;
                document.getElementById('payment-confirm').style.display = 'inline-block';
            }
            
            document.getElementById('payment-dialog').style.display = 'flex';
        }
        
        function hidePaymentDialog() {
            document.getElementById('payment-dialog').style.display = 'none';
            document.getElementById('payment-confirm').style.display = 'inline-block';
        }
        
        function showPenaltyEffect(penaltyAmount) {
            const penaltyEffect = document.createElement('div');
            penaltyEffect.className = 'penalty-effect';
            penaltyEffect.innerHTML = `
                <h2>ğŸ’£ ç‚¸å¼¹æƒ©ç½š ğŸ’£</h2>
                <div class="amount">-ç§¯åˆ†${penaltyAmount.toLocaleString()}</div>
                <p>æ‰£é™¤æƒ©ç½šé‡‘é¢</p>
            `;
            document.body.appendChild(penaltyEffect);
            
            setTimeout(() => {
                if (document.body.contains(penaltyEffect)) {
                    document.body.removeChild(penaltyEffect);
                }
            }, 2500);
        }
        
        // ç”¨æˆ·ç®¡ç†å‡½æ•°
        function saveUserData() {
            localStorage.setItem('cardGameUsers', JSON.stringify(gameData.users));
            localStorage.setItem('cardGameSessions', JSON.stringify(gameData.playerSessions));
        }
        
        // é€€å‡ºæ¸¸æˆ
        function exitToLogin() {
            if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå¹¶è¿”å›ç™»å½•é¡µé¢å—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†è¢«ä¿å­˜ã€‚')) {
                // ä¿å­˜å½“å‰æ¸¸æˆè¿›åº¦
                if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                    const userData = gameData.users[gameData.currentUser];
                    
                    // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œä¿å­˜è¿›åº¦
                    if (userData.gameProgress && !userData.gameProgress.isGameCompleted) {
                        userData.gameProgress.currentRound = gameData.currentRound;
                        userData.gameProgress.totalBonus = gameData.totalBonus;
                        userData.gameProgress.currentGameSession = gameData.currentGameSession;
                    }
                    
                    // è®°å½•æå‰é€€å‡º
                    if (gameData.gameActive) {
                        userData.stats.earlyExits++;
                    }
                }
                
                // ä¿å­˜æ•°æ®
                saveUserData();
                
                // è¿”å›ç™»å½•é¡µé¢
                gamePage.classList.remove('active');
                loginPage.classList.add('active');
                
                // æ¸…é™¤è¾“å…¥æ¡†
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('error-message').textContent = '';
            }
        }
        
        function registerUser(username, password) {
            if (gameData.users[username]) {
                return { success: false, message: 'ç”¨æˆ·åå·²å­˜åœ¨' };
            }
            
            gameData.users[username] = {
                password: password,
                created: Date.now(),
                isFirstLogin: true,
                initialFund: 0, // æ–°ç”¨æˆ·æ— èµ·å§‹åŸºé‡‘
                sessions: [], // ç”¨æˆ·çš„æ¸¸æˆä¼šè¯å†å²
                riskEstimations: [], // ç”¨æˆ·çš„é£é™©ä¼°è®¡æ•°æ®
                // æ¸¸æˆè¿›åº¦æ•°æ®
                gameProgress: {
                    currentRound: 0, // å½“å‰å®Œæˆçš„è½®æ¬¡ï¼ˆ0-9ï¼‰
                    totalBonus: 0, // å½“å‰ç´¯è®¡ä½™é¢
                    roundTypes: [], // 9è½®çš„é£é™©ç±»å‹åˆ†å¸ƒ
                    isGameCompleted: false, // æ˜¯å¦å®Œæˆå…¨éƒ¨9è½®
                    currentGameSession: null, // å½“å‰9è½®æ¸¸æˆçš„æ€»ä¼šè¯
                    allGameSessions: [] // æ‰€æœ‰å®Œæˆçš„9è½®æ¸¸æˆä¼šè¯
                },
                stats: {
                    totalFlips: 0,
                    gamesPlayed: 0,
                    roundsPlayed: 0,
                    earlyExits: 0,
                    bombTriggers: 0,
                    totalRewards: 0 // æ— èµ·å§‹åŸºé‡‘
                }
            };
            
            saveUserData();
            return { success: true, message: 'æ³¨å†ŒæˆåŠŸ', isNewUser: true };
        }
        
        function loginUser(username, password) {
            if (username === 'admin' && password === 'admin001') {
                return { success: true, isAdmin: true };
            }
            
            if (!gameData.users[username] || gameData.users[username].password !== password) {
                return { success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' };
            }
            
            gameData.currentUser = username;
            
            // ä¸ºæ—§ç”¨æˆ·æ·»åŠ æ¸¸æˆè¿›åº¦ç»“æ„ï¼ˆå‘åå…¼å®¹ï¼‰
            if (!gameData.users[username].gameProgress) {
                gameData.users[username].gameProgress = {
                    currentRound: 0,
                    totalBonus: gameData.users[username].stats.totalRewards || 0,
                    roundTypes: [],
                    isGameCompleted: false,
                    currentGameSession: null,
                    allGameSessions: []
                };
                saveUserData();
            } else if (!gameData.users[username].gameProgress.allGameSessions) {
                // ä¸ºæ—§çš„gameProgressæ·»åŠ allGameSessionså­—æ®µ
                gameData.users[username].gameProgress.allGameSessions = [];
                // å¦‚æœæœ‰currentSessionï¼Œå°†å…¶é‡å‘½åä¸ºcurrentGameSession
                if (gameData.users[username].gameProgress.currentSession) {
                    gameData.users[username].gameProgress.currentGameSession = 
                        gameData.users[username].gameProgress.currentSession;
                    delete gameData.users[username].gameProgress.currentSession;
                }
                saveUserData();
            }
            
            return { success: true, isAdmin: false };
        }
        
        // ç»“æŸå½“å‰è½®
        function endRound(reason, penaltyAmount = 0) {
            gameData.gameActive = false;
            gameData.roundEnded = true;
            
            // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ - åªæ›´æ–°å½“å‰ç”¨æˆ·çš„æ•°æ®
            if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                gameData.users[gameData.currentUser].stats.roundsPlayed++;
                if (reason === 'stop') {
                    gameData.users[gameData.currentUser].stats.earlyExits++;
                } else if (reason === 'bomb') {
                    gameData.users[gameData.currentUser].stats.bombTriggers++;
                }
            }
            
            // è®°å½•æœ¬è½®æ•°æ®
            const roundEndTime = Date.now();
            const roundDuration = gameData.currentRoundStartTime ? 
                roundEndTime - gameData.currentRoundStartTime : 0;
            
            const roundData = {
                roundNumber: gameData.currentRound,
                riskType: gameData.roundTypes[gameData.currentRound - 1],
                flippedCards: gameData.flippedCount,
                roundBonus: gameData.currentRoundBonus,
                endReason: reason,
                penaltyAmount: penaltyAmount,
                completedAt: roundEndTime,
                startTime: gameData.currentRoundStartTime,
                endTime: roundEndTime,
                durationSeconds: Math.round(roundDuration / 1000),
                // æœ¬è½®ç‚¸å¼¹ç›¸å…³æ•°æ®
                bombsTriggered: gameData.currentRoundBombsTriggered || 0,
                firstBombFlipped: gameData.currentRoundFirstBombFlipped || false,
                firstBombFlipCount: gameData.currentRoundFirstBombFlipCount || 0,
                flipsAfterFirstBomb: gameData.currentRoundFlipsAfterFirstBomb || 0
            };
            
            // å°†æœ¬è½®å¥–é‡‘åŠ åˆ°ç´¯ç§¯è·å¾—ï¼ˆä»…åœ¨è½®æ¬¡ç»“æŸæ—¶æ›´æ–°ç´¯ç§¯è·å¾—ï¼‰
            gameData.totalBonus += gameData.currentRoundBonus;
            
            const displayRoundBonus = gameData.currentRoundBonus >= 0 ? 
                `ç§¯åˆ†${gameData.currentRoundBonus.toLocaleString()}` : 
                `-ç§¯åˆ†${Math.abs(gameData.currentRoundBonus).toLocaleString()}`;
            const displayTotalBonus = gameData.totalBonus >= 0 ? 
                `ç§¯åˆ†${gameData.totalBonus.toLocaleString()}` : 
                `-ç§¯åˆ†${Math.abs(gameData.totalBonus).toLocaleString()}`;
            
            if (reason === 'win') {
                gameMessageEl.textContent = `ğŸ‰ å®Œç¾ï¼è·å¾—æœ¬è½®æ‰€æœ‰å¥–åŠ±ï¼æœ¬è½®å¥–é‡‘ï¼š${displayRoundBonus}ï¼Œç´¯ç§¯è·å¾—ï¼š${displayTotalBonus}`;
                gameMessageEl.style.color = '#4caf50';
            } else if (reason === 'stop') {
                gameMessageEl.textContent = `ğŸ›‘ æœ¬è½®ç»“æŸï¼æœ¬è½®å¥–é‡‘ï¼š${displayRoundBonus}ï¼Œç´¯ç§¯è·å¾—ï¼š${displayTotalBonus}`;
                gameMessageEl.style.color = '#ff9800';
            }
            
            // æ›´æ–°ç´¯ç§¯è·å¾—æ˜¾ç¤º
            animateNumberRoll(totalBonusEl, displayTotalBonus, gameData.currentRoundBonus >= 0);
            
            roundData.totalBonusAfter = gameData.totalBonus;
            
            // å°†è½®æ¬¡æ•°æ®æ·»åŠ åˆ°å½“å‰æ¸¸æˆä¼šè¯
            if (gameData.currentGameSession) {
                gameData.currentGameSession.rounds.push(roundData);
                gameData.currentGameSession.finalReward = gameData.totalBonus;
            }
            
            // æ›´æ–°ç”¨æˆ·æ€»å¥–åŠ±å’Œæ¸¸æˆè¿›åº¦
            if (gameData.currentUser && gameData.users[gameData.currentUser]) {
                const userData = gameData.users[gameData.currentUser];
                userData.stats.totalRewards = gameData.totalBonus;
                
                // æ›´æ–°æ¸¸æˆè¿›åº¦
                if (userData.gameProgress) {
                    userData.gameProgress.currentRound = gameData.currentRound;
                    userData.gameProgress.totalBonus = gameData.totalBonus;
                    userData.gameProgress.currentGameSession = gameData.currentGameSession;
                }
            }
            
            // ä¿å­˜æ•°æ®
            saveUserData();
            
            // å»¶è¿Ÿåè¿”å›å¼€å§‹æ¸¸æˆç•Œé¢
            setTimeout(() => {
                showGameReadyState();
            }, 2000);
        }
        
        // å¼€å§‹ä¸‹ä¸€è½®
        function nextRound() {
            showPaymentDialog();
        }
        
        // æ·»åŠ é”®ç›˜äº‹ä»¶æ”¯æŒï¼ˆå¯é€‰ï¼‰
        document.addEventListener('keydown', (event) => {
            // ESCé”®å…³é—­ç¡®è®¤å¯¹è¯æ¡†
            if (event.key === 'Escape') {
                hideConfirmDialog();
            }
        });
        
        // æ›´æ–°ç®¡ç†å‘˜ç»Ÿè®¡æ•°æ®
        function updateAdminStats() {
            // ä»æ‰€æœ‰ç”¨æˆ·æ•°æ®ä¸­ç»Ÿè®¡å…¨å±€æ•°æ®
            let totalUsers = 0;
            let totalFlipsSum = 0;
            let totalEarlyExitRateSum = 0;
            
            // éå†æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡æ•°æ®
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return; // è·³è¿‡ç®¡ç†å‘˜è´¦å·
                
                const userData = gameData.users[username];
                if (userData.stats) {
                    totalUsers++;
                    totalFlipsSum += userData.stats.totalFlips || 0;
                    
                    // è®¡ç®—è¯¥ç”¨æˆ·çš„æå‰é€€å‡ºç‡
                    const roundsPlayed = userData.stats.roundsPlayed || 0;
                    const earlyExits = userData.stats.earlyExits || 0;
                    const userExitRate = roundsPlayed > 0 ? (earlyExits / roundsPlayed * 100) : 0;
                    totalEarlyExitRateSum += userExitRate;
                }
            });
            
            // è®¡ç®—å¹³å‡å€¼
            const avgTotalFlips = totalUsers > 0 ? (totalFlipsSum / totalUsers) : 0;
            const avgEarlyExitRate = totalUsers > 0 ? (totalEarlyExitRateSum / totalUsers) : 0;
            
            // æ›´æ–°æ˜¾ç¤º
            avgTotalFlipsEl.textContent = avgTotalFlips.toFixed(1);
            avgEarlyExitRateEl.textContent = `${avgEarlyExitRate.toFixed(1)}%`;
            
            // æ›´æ–°ç”¨æˆ·è¯¦ç»†æ•°æ®
            updateUserDataTable();
        }
        
        function updateUserDataTable() {
            const userDataList = document.getElementById('user-data-list');
            if (!userDataList) {
                console.error('user-data-list element not found');
                return;
            }
            
            userDataList.innerHTML = '';
            
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return; // è·³è¿‡ç®¡ç†å‘˜è´¦å·
                
                const userData = gameData.users[username];
                
                // ç¡®ä¿ç»Ÿè®¡æ•°æ®å­˜åœ¨
                if (!userData.stats) {
                    userData.stats = {
                        totalFlips: 0,
                        gamesPlayed: 0,
                        roundsPlayed: 0,
                        earlyExits: 0,
                        bombTriggers: 0,
                        totalRewards: 0
                    };
                }
                
                // åˆ›å»ºç”¨æˆ·è¡Œå®¹å™¨
                const userRowContainer = document.createElement('div');
                
                // åˆ›å»ºä¸»æ•°æ®è¡Œ
                const userRow = document.createElement('div');
                userRow.className = 'user-row';
                userRow.style.cursor = 'pointer';
                
                // è®¡ç®—ç”¨æˆ·ç»Ÿè®¡æ•°æ®
                const totalFlips = userData.stats.totalFlips || 0;
                
                // è®¡ç®—æ¸¸æˆæ€»æ—¶é•¿ï¼ˆç§’ï¼‰- ä»æ‰€æœ‰è½®æ¬¡æ•°æ®ä¸­ç»Ÿè®¡
                let totalGameTimeSeconds = 0;
                const allGameSessions = userData.gameProgress?.allGameSessions || [];
                
                // ç»Ÿè®¡å·²å®Œæˆçš„æ¸¸æˆä¸­æ¯è½®çš„æ—¶é•¿
                allGameSessions.forEach(gameSession => {
                    if (gameSession.rounds) {
                        gameSession.rounds.forEach(round => {
                            if (round.durationSeconds) {
                                totalGameTimeSeconds += round.durationSeconds;
                            }
                        });
                    }
                });
                
                // åŠ ä¸Šå½“å‰è¿›è¡Œä¸­çš„æ¸¸æˆè½®æ¬¡æ—¶é•¿
                if (userData.gameProgress?.currentGameSession?.rounds) {
                    userData.gameProgress.currentGameSession.rounds.forEach(round => {
                        if (round.durationSeconds) {
                            totalGameTimeSeconds += round.durationSeconds;
                        }
                    });
                }
                
                // è½¬æ¢ä¸ºåˆ†é’Ÿå’Œç§’æ˜¾ç¤º
                const totalMinutes = Math.floor(totalGameTimeSeconds / 60);
                const remainingSeconds = totalGameTimeSeconds % 60;
                const totalGameTimeDisplay = `${totalMinutes}åˆ†${remainingSeconds}ç§’`;
                
                // æå‰é€€å‡ºç‡
                const earlyExitRate = userData.stats.roundsPlayed > 0 ? 
                    (userData.stats.earlyExits / userData.stats.roundsPlayed * 100).toFixed(1) : '0.0';
                
                // å¹³å‡ç¿»ç‰Œæ¬¡æ•°
                const avgFlips = userData.stats.roundsPlayed > 0 ? 
                    (userData.stats.totalFlips / userData.stats.roundsPlayed).toFixed(1) : '0.0';
                
                // å½“å‰æ¸¸æˆè¿›åº¦
                let gameProgress = 'æœªå¼€å§‹';
                if (userData.gameProgress) {
                    if (userData.gameProgress.isGameCompleted) {
                        gameProgress = 'å·²å®Œæˆ9è½® 100%';
                    } else if (userData.gameProgress.currentRound > 0) {
                        const progressPercent = ((userData.gameProgress.currentRound / 9) * 100).toFixed(0);
                        gameProgress = `å·²å®Œæˆ${userData.gameProgress.currentRound}è½® ${progressPercent}%`;
                    }
                }
                
                userRow.innerHTML = `
                    <div>${username}</div>
                    <div>${totalGameTimeDisplay}</div>
                    <div>${totalFlips}</div>
                    <div>${earlyExitRate}%</div>
                    <div>${avgFlips}</div>
                    <div>${gameProgress}</div>
                    <div>
                        <button class="btn-small" onclick="toggleUserDetail('${username}')">å±•å¼€</button>
                        <button class="btn-small" onclick="resetUserProgress('${username}')" style="background: linear-gradient(to right, #ff9800, #f57c00);">é‡ç½®è¿›åº¦</button>
                        <button class="btn-small btn-danger" onclick="deleteUser('${username}')">åˆ é™¤</button>
                    </div>
                `;
                
                // åˆ›å»ºè¯¦æƒ…è¡Œ
                const detailRow = document.createElement('div');
                detailRow.className = 'user-detail-row';
                detailRow.id = `detail-${username}`;
                
                userRowContainer.appendChild(userRow);
                userRowContainer.appendChild(detailRow);
                userDataList.appendChild(userRowContainer);
            });
        }
        
        function generateUserDetailContent(username, userData) {
            let content = '<div class="user-detail-content">';
            content += `<h4>ğŸ“Š ${username} è¯¦ç»†æ•°æ®</h4>`;
            content += `<p><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${new Date(userData.created).toLocaleString()}</p>`;
            content += `<p><strong>ç´¯ç§¯è·å¾—ï¼š</strong>ç§¯åˆ†${userData.stats.totalRewards.toLocaleString()}</p>`;
            
            // æ”¶é›†æ‰€æœ‰è½®æ¬¡æ•°æ®ï¼ˆå·²å®Œæˆå’Œè¿›è¡Œä¸­çš„ï¼‰
            const allRounds = [];
            const allGameSessions = userData.gameProgress?.allGameSessions || [];
            
            // ä»å·²å®Œæˆçš„æ¸¸æˆä¼šè¯ä¸­æ”¶é›†è½®æ¬¡æ•°æ®
            allGameSessions.forEach(gameSession => {
                if (gameSession.rounds) {
                    gameSession.rounds.forEach(round => {
                        allRounds.push(round);
                    });
                }
            });
            
            // ä»å½“å‰è¿›è¡Œä¸­çš„æ¸¸æˆä¼šè¯ä¸­æ”¶é›†è½®æ¬¡æ•°æ®
            if (userData.gameProgress?.currentGameSession?.rounds) {
                const currentSession = userData.gameProgress.currentGameSession;
                currentSession.rounds.forEach(round => {
                    allRounds.push(round);
                });
            }
            
            // æŒ‰è½®æ¬¡åˆ†ç»„
            const roundsByNumber = {};
            for (let i = 1; i <= 9; i++) {
                roundsByNumber[i] = allRounds.filter(round => round.roundNumber === i);
            }
            
            // ä¸ºæ¯ä¸€è½®åˆ›å»ºè¡¨æ ¼
            for (let roundNum = 1; roundNum <= 9; roundNum++) {
                const roundData = roundsByNumber[roundNum];
                
                content += `<h4>ğŸ¯ ç¬¬${roundNum}è½®æ¸¸æˆæ•°æ®</h4>`;
                
                if (roundData.length === 0) {
                    content += `<p style="color: #888; margin-bottom: 20px;">è¯¥è½®æ¬¡å°šæœªå¼€å§‹</p>`;
                    continue;
                }
                
                content += `<div class="round-table-container" style="margin-bottom: 25px;">`;
                content += `<table style="width: 100%; border-collapse: collapse; background: rgba(0, 20, 40, 0.5); border-radius: 8px; overflow: hidden;">`;
                content += `<thead><tr style="background: rgba(25, 118, 210, 0.3);">`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">æ¸¸æˆåœºæ¬¡</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">é£é™©ç­‰çº§</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">ç¿»ç‰Œæ¬¡æ•°</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">æ¸¸æˆæ—¶é•¿</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">è§¦å‘ç‚¸å¼¹åç»§ç»­</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">ç‚¸å¼¹åç¿»ç‰Œæ•°</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">ç‚¸å¼¹è§¦å‘æ¬¡æ•°</th>`;
                content += `<th style="padding: 10px; color: #4fc3f7; border-bottom: 1px solid rgba(255,255,255,0.1);">ç´¯ç§¯è·å¾—</th>`;
                content += `</tr></thead><tbody>`;
                
                roundData.forEach((round, index) => {
                    // è®¡ç®—æ¸¸æˆæ—¶é•¿ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
                    const gameTimeSeconds = round.durationSeconds || 0;
                    const minutes = Math.floor(gameTimeSeconds / 60);
                    const seconds = gameTimeSeconds % 60;
                    const gameTimeDisplay = `${minutes}åˆ†${seconds}ç§’`;
                    
                    // è·å–é£é™©ç­‰çº§
                    const riskType = round.riskType || 'unknown';
                    const riskText = riskType === 'low' ? 'ä½é£é™©' : (riskType === 'medium' ? 'ä¸­é£é™©' : (riskType === 'high' ? 'é«˜é£é™©' : 'æœªçŸ¥'));
                    const riskColor = riskType === 'low' ? '#4caf50' : (riskType === 'medium' ? '#ff9800' : '#f44336');
                    
                    // åˆ¤æ–­æ˜¯å¦åœ¨è¯¥è½®è§¦å‘ç¬¬ä¸€ä¸ªç‚¸å¼¹åç»§ç»­ç¿»ç‰Œ
                    let continueAfterBomb = 'å¦';
                    let flipsAfterBomb = 0;
                    
                    // ä½¿ç”¨æœ¬è½®çš„ç‚¸å¼¹æ•°æ®
                    if (round.firstBombFlipped) {
                        // è¯¥è½®è§¦å‘äº†ç¬¬ä¸€ä¸ªç‚¸å¼¹
                        continueAfterBomb = round.flipsAfterFirstBomb > 0 ? 'æ˜¯' : 'å¦';
                        flipsAfterBomb = round.flipsAfterFirstBomb || 0;
                    }
                    
                    // è®¡ç®—è¯¥è½®ç‚¸å¼¹è§¦å‘æ¬¡æ•°
                    const bombCount = round.bombsTriggered || 0;
                    
                    // ç´¯ç§¯è·å¾—
                    const balance = round.totalBonusAfter !== undefined ? 
                        `ç§¯åˆ†${round.totalBonusAfter.toLocaleString()}` : 'æœªçŸ¥';
                    
                    content += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">`;
                    content += `<td style="padding: 8px; color: #fff;">ç¬¬${index + 1}åœº</td>`;
                    content += `<td style="padding: 8px; color: ${riskColor}; font-weight: bold;">${riskText}</td>`;
                    content += `<td style="padding: 8px; color: #fff;">${round.flippedCards || 0}</td>`;
                    content += `<td style="padding: 8px; color: #fff;">${gameTimeDisplay}</td>`;
                    content += `<td style="padding: 8px; color: #fff;">${continueAfterBomb}</td>`;
                    content += `<td style="padding: 8px; color: #fff;">${flipsAfterBomb}</td>`;
                    content += `<td style="padding: 8px; color: #fff;">${bombCount}</td>`;
                    content += `<td style="padding: 8px; color: #fff;">${balance}</td>`;
                    content += `</tr>`;
                });
                
                content += `</tbody></table></div>`;
            }
            
            if (allRounds.length === 0) {
                content += `<p style="color: #888;">è¯¥ç”¨æˆ·å°šæœªå¼€å§‹æ¸¸æˆ</p>`;
            }
            
            content += '</div>';
            return content;
        }
        
        function toggleUserDetail(username) {
            const detailRow = document.getElementById(`detail-${username}`);
            if (!detailRow) {
                console.error(`Detail row not found for user: ${username}`);
                return;
            }
            
            if (detailRow.classList.contains('expanded')) {
                detailRow.classList.remove('expanded');
            } else {
                // åœ¨å±•å¼€æ—¶ç”Ÿæˆè¯¦ç»†å†…å®¹
                const userData = gameData.users[username];
                if (userData) {
                    detailRow.innerHTML = generateUserDetailContent(username, userData);
                }
                detailRow.classList.add('expanded');
            }
        }
        
        function resetUserProgress(username) {
            if (confirm(`ç¡®å®šè¦é‡ç½®ç”¨æˆ· "${username}" çš„æ¸¸æˆè¿›åº¦å—ï¼Ÿç”¨æˆ·å°†å¯ä»¥é‡æ–°å¼€å§‹9è½®æ¸¸æˆï¼Œä½†å·²æœ‰çš„ç»Ÿè®¡æ•°æ®å’Œä½™é¢å°†ä¿ç•™ã€‚`)) {
                const userData = gameData.users[username];
                if (userData && userData.gameProgress) {
                    // å¦‚æœå½“å‰æ¸¸æˆæœªå®Œæˆï¼Œä¿å­˜åˆ°å†å²è®°å½•
                    if (userData.gameProgress.currentGameSession && !userData.gameProgress.isGameCompleted) {
                        if (!userData.gameProgress.allGameSessions) {
                            userData.gameProgress.allGameSessions = [];
                        }
                        userData.gameProgress.currentGameSession.isCompleted = false;
                        userData.gameProgress.currentGameSession.gameEndTime = Date.now();
                        userData.gameProgress.allGameSessions.push({...userData.gameProgress.currentGameSession});
                    }
                    
                    // é‡ç½®æ¸¸æˆè¿›åº¦ï¼Œä½†ä¿ç•™ç´¯ç§¯è·å¾—
                    userData.gameProgress.currentRound = 0;
                    userData.gameProgress.roundTypes = [];
                    userData.gameProgress.isGameCompleted = false;
                    userData.gameProgress.currentGameSession = null;
                    
                    saveUserData();
                    updateUserDataTable();
                    alert(`ç”¨æˆ· "${username}" çš„æ¸¸æˆè¿›åº¦å·²é‡ç½®ï¼`);
                }
            }
        }
        
        function deleteUser(username) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) {
                // åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®
                delete gameData.users[username];
                
                // ä»å…¨å±€playerSessionsä¸­åˆ é™¤è¯¥ç”¨æˆ·çš„ç›¸å…³ä¼šè¯
                gameData.playerSessions = gameData.playerSessions.filter(session => 
                    session.username !== username);
                
                saveUserData();
                updateUserDataTable();
            }
        }
        
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                gameData.users = {};
                gameData.playerSessions = [];
                gameData.stats = {
                    totalFlips: 0,
                    gamesPlayed: 0,
                    roundsPlayed: 0,
                    earlyExits: 0,
                    bombTriggers: 0,
                    totalPossibleReward: 0,
                    totalActualReward: 0,
                    riskEstimations: [],
                    averageCardsFlippedPerRound: 0
                };
                saveUserData();
                updateAdminStats();
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }
        
        // å¯¼å‡ºæ•°æ®åˆ°Excel
        function exportDataToExcel() {
            // æ”¶é›†æ‰€æœ‰ç”¨æˆ·åç”¨äºæ–‡ä»¶å‘½å
            const usernames = [];
            Object.keys(gameData.users).forEach(username => {
                if (username !== 'admin') {
                    usernames.push(username);
                }
            });
            
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = {
                SheetNames: [],
                Sheets: {}
            };
            
            // 1. åˆ›å»ºç”¨æˆ·æ¦‚è§ˆæ•°æ®è¡¨
            const userSummaryData = [];
            userSummaryData.push(['ç”¨æˆ·å', 'æ³¨å†Œæ—¶é—´', 'æ¸¸æˆæ€»æ—¶é•¿(ç§’)', 'ç¿»ç‰Œæ€»æ•°', 'æå‰é€€å‡ºç‡(%)', 'å¹³å‡ç¿»ç‰Œæ¬¡æ•°', 'ç‚¸å¼¹è§¦å‘æ¬¡æ•°', 'å½“å‰ä½™é¢', 'æ¸¸æˆè¿›åº¦']);
            
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return;
                const userData = gameData.users[username];
                
                // è®¡ç®—æ¸¸æˆæ€»æ—¶é•¿
                let totalGameTimeSeconds = 0;
                const allGameSessions = userData.gameProgress?.allGameSessions || [];
                allGameSessions.forEach(gameSession => {
                    if (gameSession.rounds) {
                        gameSession.rounds.forEach(round => {
                            if (round.durationSeconds) {
                                totalGameTimeSeconds += round.durationSeconds;
                            }
                        });
                    }
                });
                if (userData.gameProgress?.currentGameSession?.rounds) {
                    userData.gameProgress.currentGameSession.rounds.forEach(round => {
                        if (round.durationSeconds) {
                            totalGameTimeSeconds += round.durationSeconds;
                        }
                    });
                }
                
                const earlyExitRate = userData.stats.roundsPlayed > 0 ? 
                    ((userData.stats.earlyExits / userData.stats.roundsPlayed) * 100).toFixed(2) : '0.00';
                const avgFlips = userData.stats.roundsPlayed > 0 ? 
                    (userData.stats.totalFlips / userData.stats.roundsPlayed).toFixed(1) : '0.0';
                
                let gameProgress = 'æœªå¼€å§‹';
                if (userData.gameProgress) {
                    if (userData.gameProgress.isGameCompleted) {
                        gameProgress = 'å·²å®Œæˆ9è½®';
                    } else if (userData.gameProgress.currentRound > 0) {
                        gameProgress = `å·²å®Œæˆ${userData.gameProgress.currentRound}è½®`;
                    }
                }
                
                userSummaryData.push([
                    username,
                    new Date(userData.created).toLocaleString('zh-CN'),
                    totalGameTimeSeconds,
                    userData.stats.totalFlips || 0,
                    earlyExitRate,
                    avgFlips,
                    userData.stats.bombTriggers || 0,
                    userData.stats.totalRewards || 0,
                    gameProgress
                ]);
            });
            
            wb.SheetNames.push('ç”¨æˆ·æ¦‚è§ˆ');
            wb.Sheets['ç”¨æˆ·æ¦‚è§ˆ'] = arrayToSheet(userSummaryData);
            
            // 2. åˆ›å»ºè¯¦ç»†è½®æ¬¡æ•°æ®è¡¨
            const roundDetailData = [];
            roundDetailData.push(['ç”¨æˆ·å', 'æ¸¸æˆåœºæ¬¡', 'è½®æ¬¡', 'é£é™©ç­‰çº§', 'ç¿»ç‰Œæ¬¡æ•°', 'æ¸¸æˆæ—¶é•¿(ç§’)', 'è§¦å‘ç‚¸å¼¹åç»§ç»­', 'ç‚¸å¼¹åç¿»ç‰Œæ•°', 'ç‚¸å¼¹è§¦å‘æ¬¡æ•°', 'è½®æ¬¡ä½™é¢', 'ç»“æŸæ—¶é—´']);
            
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return;
                const userData = gameData.users[username];
                
                const allRounds = [];
                const allGameSessions = userData.gameProgress?.allGameSessions || [];
                
                allGameSessions.forEach((gameSession, sessionIndex) => {
                    if (gameSession.rounds) {
                        gameSession.rounds.forEach(round => {
                            allRounds.push({
                                sessionIndex: sessionIndex + 1,
                                ...round
                            });
                        });
                    }
                });
                
                if (userData.gameProgress?.currentGameSession?.rounds) {
                    const currentSessionIndex = allGameSessions.length + 1;
                    userData.gameProgress.currentGameSession.rounds.forEach(round => {
                        allRounds.push({
                            sessionIndex: currentSessionIndex,
                            ...round
                        });
                    });
                }
                
                allRounds.forEach(round => {
                    const riskText = round.riskType === 'low' ? 'ä½é£é™©' : 
                                    (round.riskType === 'medium' ? 'ä¸­é£é™©' : 'é«˜é£é™©');
                    const continueAfterBomb = round.firstBombFlipped ? 
                        (round.flipsAfterFirstBomb > 0 ? 'æ˜¯' : 'å¦') : 'å¦';
                    const flipsAfterBomb = round.flipsAfterFirstBomb || 0;
                    const bombCount = round.bombsTriggered || 0;
                    const endTime = round.completedAt ? new Date(round.completedAt).toLocaleString('zh-CN') : '';
                    
                    roundDetailData.push([
                        username,
                        `ç¬¬${round.sessionIndex}åœº`,
                        `ç¬¬${round.roundNumber}è½®`,
                        riskText,
                        round.flippedCards || 0,
                        round.durationSeconds || 0,
                        continueAfterBomb,
                        flipsAfterBomb,
                        bombCount,
                        round.totalBonusAfter || 0,
                        endTime
                    ]);
                });
            });
            
            wb.SheetNames.push('è½®æ¬¡è¯¦ç»†æ•°æ®');
            wb.Sheets['è½®æ¬¡è¯¦ç»†æ•°æ®'] = arrayToSheet(roundDetailData);
            
            // 3. åˆ›å»ºå…¨å±€ç»Ÿè®¡æ•°æ®è¡¨
            const globalStatsData = [];
            globalStatsData.push(['ç»Ÿè®¡é¡¹ç›®', 'æ•°å€¼']);
            
            let totalUsers = 0;
            let totalFlipsSum = 0;
            let totalEarlyExitRateSum = 0;
            
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return;
                const userData = gameData.users[username];
                if (userData.stats) {
                    totalUsers++;
                    totalFlipsSum += userData.stats.totalFlips || 0;
                    const roundsPlayed = userData.stats.roundsPlayed || 0;
                    const earlyExits = userData.stats.earlyExits || 0;
                    const userExitRate = roundsPlayed > 0 ? (earlyExits / roundsPlayed * 100) : 0;
                    totalEarlyExitRateSum += userExitRate;
                }
            });
            
            const avgTotalFlips = totalUsers > 0 ? (totalFlipsSum / totalUsers).toFixed(1) : '0.0';
            const avgEarlyExitRate = totalUsers > 0 ? (totalEarlyExitRateSum / totalUsers).toFixed(1) : '0.0';
            
            globalStatsData.push(['æ€»ç”¨æˆ·æ•°', totalUsers]);
            globalStatsData.push(['å¹³å‡ç¿»ç‰Œæ€»æ¬¡æ•°', avgTotalFlips]);
            globalStatsData.push(['å¹³å‡æå‰é€€å‡ºç‡(%)', avgEarlyExitRate]);
            globalStatsData.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
            
            wb.SheetNames.push('å…¨å±€ç»Ÿè®¡');
            wb.Sheets['å…¨å±€ç»Ÿè®¡'] = arrayToSheet(globalStatsData);
            
            // è½¬æ¢ä¸ºExcelå¹¶ä¸‹è½½
            // ç”Ÿæˆæ–‡ä»¶åï¼šç›®æ ‡_ç”¨æˆ·å1_ç”¨æˆ·å2...
            const filename = usernames.length > 0 ? 
                `ç›®æ ‡_${usernames.join('_')}.xlsx` : 
                'ç›®æ ‡_æ— ç”¨æˆ·æ•°æ®.xlsx';
            downloadExcel(wb, filename);
        }
        
        // å°†äºŒç»´æ•°ç»„è½¬æ¢ä¸ºå·¥ä½œè¡¨å¯¹è±¡
        function arrayToSheet(data) {
            const sheet = {};
            const range = {s: {c: 0, r: 0}, e: {c: 0, r: 0}};
            
            for (let R = 0; R < data.length; ++R) {
                for (let C = 0; C < data[R].length; ++C) {
                    if (range.s.r > R) range.s.r = R;
                    if (range.s.c > C) range.s.c = C;
                    if (range.e.r < R) range.e.r = R;
                    if (range.e.c < C) range.e.c = C;
                    
                    const cell = {v: data[R][C]};
                    if (cell.v == null) continue;
                    
                    const cell_ref = encodeCell({c: C, r: R});
                    
                    if (typeof cell.v === 'number') cell.t = 'n';
                    else if (typeof cell.v === 'boolean') cell.t = 'b';
                    else cell.t = 's';
                    
                    sheet[cell_ref] = cell;
                }
            }
            
            sheet['!ref'] = encodeRange(range);
            return sheet;
        }
        
        // ç¼–ç å•å…ƒæ ¼å¼•ç”¨
        function encodeCell(cell) {
            return String.fromCharCode(65 + cell.c) + (cell.r + 1);
        }
        
        // ç¼–ç èŒƒå›´
        function encodeRange(range) {
            return encodeCell(range.s) + ':' + encodeCell(range.e);
        }
        
        // ä¸‹è½½Excelæ–‡ä»¶
        function downloadExcel(wb, filename) {
            const wbout = writeWorkbook(wb);
            const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // å°†å·¥ä½œç°¿å†™å…¥äºŒè¿›åˆ¶å­—ç¬¦ä¸²
        function writeWorkbook(wb) {
            const buf = new ArrayBuffer(10000000);
            const view = new Uint8Array(buf);
            let idx = 0;
            
            // ç®€åŒ–çš„XLSXæ ¼å¼å†™å…¥
            const zip = createZip();
            
            // [Content_Types].xml
            zip.file('[Content_Types].xml', 
                '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                '<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">' +
                '<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>' +
                '<Default Extension="xml" ContentType="application/xml"/>' +
                '<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>' +
                wb.SheetNames.map((name, i) => 
                    `<Override PartName="/xl/worksheets/sheet${i+1}.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>`
                ).join('') +
                '</Types>');
            
            // _rels/.rels
            zip.file('_rels/.rels',
                '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                '<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">' +
                '<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>' +
                '</Relationships>');
            
            // xl/workbook.xml
            zip.file('xl/workbook.xml',
                '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                '<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">' +
                '<sheets>' +
                wb.SheetNames.map((name, i) => 
                    `<sheet name="${name}" sheetId="${i+1}" r:id="rId${i+1}"/>`
                ).join('') +
                '</sheets>' +
                '</workbook>');
            
            // xl/_rels/workbook.xml.rels
            zip.file('xl/_rels/workbook.xml.rels',
                '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                '<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">' +
                wb.SheetNames.map((name, i) => 
                    `<Relationship Id="rId${i+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet${i+1}.xml"/>`
                ).join('') +
                '</Relationships>');
            
            // xl/worksheets/sheetN.xml
            wb.SheetNames.forEach((name, i) => {
                const sheet = wb.Sheets[name];
                const range = sheet['!ref'] ? decodeRange(sheet['!ref']) : {s: {c:0, r:0}, e: {c:0, r:0}};
                
                let sheetData = '<sheetData>';
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    let row = `<row r="${R + 1}">`;
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_ref = encodeCell({c: C, r: R});
                        const cell = sheet[cell_ref];
                        if (!cell) continue;
                        
                        const cellType = cell.t === 'n' ? '' : ' t="inlineStr"';
                        const cellValue = cell.t === 'n' ? 
                            `<v>${cell.v}</v>` : 
                            `<is><t>${escapeXml(String(cell.v))}</t></is>`;
                        
                        row += `<c r="${cell_ref}"${cellType}>${cellValue}</c>`;
                    }
                    row += '</row>';
                    sheetData += row;
                }
                sheetData += '</sheetData>';
                
                zip.file(`xl/worksheets/sheet${i+1}.xml`,
                    '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' +
                    '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">' +
                    sheetData +
                    '</worksheet>');
            });
            
            return zip.generate();
        }
        
        // è§£ç èŒƒå›´
        function decodeRange(range) {
            const parts = range.split(':');
            return {
                s: decodeCell(parts[0]),
                e: decodeCell(parts[1])
            };
        }
        
        // è§£ç å•å…ƒæ ¼
        function decodeCell(cell) {
            const match = cell.match(/([A-Z]+)(\d+)/);
            return {
                c: match[1].charCodeAt(0) - 65,
                r: parseInt(match[2]) - 1
            };
        }
        
        // XMLè½¬ä¹‰
        function escapeXml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }
        
        // ç®€åŒ–çš„ZIPåˆ›å»ºå™¨
        function createZip() {
            const files = {};
            return {
                file: function(name, content) {
                    files[name] = content;
                },
                generate: function() {
                    // ä½¿ç”¨CSVæ ¼å¼ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                    return files;
                }
            };
        }
        
        // å­—ç¬¦ä¸²è½¬ArrayBuffer
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) {
                view[i] = s.charCodeAt(i) & 0xFF;
            }
            return buf;
        }
        
        // ç®€åŒ–ç‰ˆï¼šå¯¼å‡ºä¸ºCSVæ ¼å¼ï¼ˆæ›´å¯é ï¼‰
        function exportDataToCSV() {
            let csv = '\uFEFF'; // UTF-8 BOM
            
            // æ”¶é›†æ‰€æœ‰ç”¨æˆ·åç”¨äºæ–‡ä»¶å‘½å
            const usernames = [];
            Object.keys(gameData.users).forEach(username => {
                if (username !== 'admin') {
                    usernames.push(username);
                }
            });
            
            // ç”¨æˆ·æ¦‚è§ˆ
            csv += 'ç”¨æˆ·æ¦‚è§ˆ\n';
            csv += 'ç”¨æˆ·å,æ³¨å†Œæ—¶é—´,æ¸¸æˆæ€»æ—¶é•¿(ç§’),ç¿»ç‰Œæ€»æ•°,æå‰é€€å‡ºç‡(%),å¹³å‡ç¿»ç‰Œæ¬¡æ•°,ç‚¸å¼¹è§¦å‘æ¬¡æ•°,å½“å‰ä½™é¢,æ¸¸æˆè¿›åº¦\n';
            
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return;
                const userData = gameData.users[username];
                
                let totalGameTimeSeconds = 0;
                const allGameSessions = userData.gameProgress?.allGameSessions || [];
                allGameSessions.forEach(gameSession => {
                    if (gameSession.rounds) {
                        gameSession.rounds.forEach(round => {
                            if (round.durationSeconds) totalGameTimeSeconds += round.durationSeconds;
                        });
                    }
                });
                if (userData.gameProgress?.currentGameSession?.rounds) {
                    userData.gameProgress.currentGameSession.rounds.forEach(round => {
                        if (round.durationSeconds) totalGameTimeSeconds += round.durationSeconds;
                    });
                }
                
                const earlyExitRate = userData.stats.roundsPlayed > 0 ? 
                    ((userData.stats.earlyExits / userData.stats.roundsPlayed) * 100).toFixed(2) : '0.00';
                const avgFlips = userData.stats.roundsPlayed > 0 ? 
                    (userData.stats.totalFlips / userData.stats.roundsPlayed).toFixed(1) : '0.0';
                
                let gameProgress = 'æœªå¼€å§‹';
                if (userData.gameProgress) {
                    if (userData.gameProgress.isGameCompleted) {
                        gameProgress = 'å·²å®Œæˆ9è½®';
                    } else if (userData.gameProgress.currentRound > 0) {
                        gameProgress = `å·²å®Œæˆ${userData.gameProgress.currentRound}è½®`;
                    }
                }
                
                csv += `${username},${new Date(userData.created).toLocaleString('zh-CN')},${totalGameTimeSeconds},${userData.stats.totalFlips || 0},${earlyExitRate},${avgFlips},${userData.stats.bombTriggers || 0},${userData.stats.totalRewards || 0},${gameProgress}\n`;
            });
            
            csv += '\n\nè½®æ¬¡è¯¦ç»†æ•°æ®\n';
            csv += 'ç”¨æˆ·å,æ¸¸æˆåœºæ¬¡,è½®æ¬¡,é£é™©ç­‰çº§,ç¿»ç‰Œæ¬¡æ•°,æ¸¸æˆæ—¶é•¿(ç§’),è§¦å‘ç‚¸å¼¹åç»§ç»­,ç‚¸å¼¹åç¿»ç‰Œæ•°,ç‚¸å¼¹è§¦å‘æ¬¡æ•°,è½®æ¬¡ä½™é¢,ç»“æŸæ—¶é—´\n';
            
            Object.keys(gameData.users).forEach(username => {
                if (username === 'admin') return;
                const userData = gameData.users[username];
                
                const allRounds = [];
                const allGameSessions = userData.gameProgress?.allGameSessions || [];
                
                allGameSessions.forEach((gameSession, sessionIndex) => {
                    if (gameSession.rounds) {
                        gameSession.rounds.forEach(round => {
                            allRounds.push({sessionIndex: sessionIndex + 1, ...round});
                        });
                    }
                });
                
                if (userData.gameProgress?.currentGameSession?.rounds) {
                    const currentSessionIndex = allGameSessions.length + 1;
                    userData.gameProgress.currentGameSession.rounds.forEach(round => {
                        allRounds.push({sessionIndex: currentSessionIndex, ...round});
                    });
                }
                
                allRounds.forEach(round => {
                    const riskText = round.riskType === 'low' ? 'ä½é£é™©' : 
                                    (round.riskType === 'medium' ? 'ä¸­é£é™©' : 'é«˜é£é™©');
                    const continueAfterBomb = round.firstBombFlipped ? 
                        (round.flipsAfterFirstBomb > 0 ? 'æ˜¯' : 'å¦') : 'å¦';
                    const flipsAfterBomb = round.flipsAfterFirstBomb || 0;
                    const bombCount = round.bombsTriggered || 0;
                    const endTime = round.completedAt ? new Date(round.completedAt).toLocaleString('zh-CN') : '';
                    
                    csv += `${username},ç¬¬${round.sessionIndex}åœº,ç¬¬${round.roundNumber}è½®,${riskText},${round.flippedCards || 0},${round.durationSeconds || 0},${continueAfterBomb},${flipsAfterBomb},${bombCount},${round.totalBonusAfter || 0},${endTime}\n`;
                });
            });
            
            // ä¸‹è½½CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // ç”Ÿæˆæ–‡ä»¶åï¼šç›®æ ‡_ç”¨æˆ·å1_ç”¨æˆ·å2...
            const filename = usernames.length > 0 ? 
                `è¿‡ç¨‹_${usernames.join('_')}.csv` : 
                'è¿‡ç¨‹_æ— ç”¨æˆ·æ•°æ®.csv';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('login-btn').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorEl = document.getElementById('error-message');
            
            errorEl.textContent = '';
            
            if (!username || !password) {
                errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }
            
            if (gameData.isRegistering) {
                // æ³¨å†Œæ¨¡å¼
                if (password !== confirmPassword) {
                    errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                    return;
                }
                
                const result = registerUser(username, password);
                if (result.success) {
                    errorEl.style.color = '#4caf50';
                    errorEl.textContent = result.message;
                    
                    // åˆ‡æ¢å›ç™»å½•æ¨¡å¼
                    setTimeout(() => {
                        toggleRegisterMode(false);
                        document.getElementById('username').value = username;
                        document.getElementById('password').value = '';
                        errorEl.textContent = '';
                        errorEl.style.color = '#ff4444';
                    }, 1500);
                } else {
                    errorEl.textContent = result.message;
                }
            } else {
                // ç™»å½•æ¨¡å¼
                const result = loginUser(username, password);
                if (result.success) {
                    if (result.isAdmin) {
                        loginPage.classList.remove('active');
                        adminPage.classList.add('active');
                        updateAdminStats();
                    } else {
                        // æ™®é€šç”¨æˆ·å…ˆæ˜¾ç¤ºæ¸¸æˆè§„åˆ™é¡µé¢
                        loginPage.classList.remove('active');
                        rulesPage.classList.add('active');
                    }
                } else {
                    errorEl.textContent = result.message;
                }
            }
        });
        
        document.getElementById('register-btn').addEventListener('click', () => {
            toggleRegisterMode(!gameData.isRegistering);
        });
        
        function toggleRegisterMode(isRegistering) {
            gameData.isRegistering = isRegistering;
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const confirmPasswordGroup = document.getElementById('confirm-password-group');
            const errorEl = document.getElementById('error-message');
            
            if (isRegistering) {
                loginBtn.textContent = 'ç¡®è®¤æ³¨å†Œ';
                registerBtn.textContent = 'è¿”å›ç™»å½•';
                confirmPasswordGroup.style.display = 'block';
            } else {
                loginBtn.textContent = 'ç™»å½•æ¸¸æˆ';
                registerBtn.textContent = 'æ³¨å†Œè´¦å·';
                confirmPasswordGroup.style.display = 'none';
                document.getElementById('confirm-password').value = '';
            }
            
            errorEl.textContent = '';
            errorEl.style.color = '#ff4444';
        }
        
        // æ¸¸æˆè§„åˆ™é¡µé¢äº‹ä»¶ç›‘å¬
        document.getElementById('exit-to-login-btn').addEventListener('click', () => {
            rulesPage.classList.remove('active');
            loginPage.classList.add('active');
            
            // æ¸…é™¤è¾“å…¥æ¡†
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('error-message').textContent = '';
        });
        
        document.getElementById('enter-game-btn').addEventListener('click', () => {
            rulesPage.classList.remove('active');
            gamePage.classList.add('active');
            
            // åˆå§‹åŒ–æ¸¸æˆé¡µé¢
            initGame();
        });
        
        document.getElementById('start-game-btn').addEventListener('click', () => {
            // ç›´æ¥å¼€å§‹æ¸¸æˆï¼Œæ— éœ€æ”¯ä»˜è´¹ç”¨
            startNewRound();
        });
        
        document.getElementById('stop-round-btn').addEventListener('click', () => {
            if (gameData.gameActive && !gameData.roundEnded) {
                showConfirmDialog();
            }
        });
        
        document.getElementById('dialog-confirm').addEventListener('click', () => {
            hideConfirmDialog();
            endRound('stop');
        });
        
        document.getElementById('dialog-cancel').addEventListener('click', () => {
            hideConfirmDialog();
        });
        
        // ä»˜è´¹å¯¹è¯æ¡†äº‹ä»¶ç›‘å¬
        document.getElementById('payment-confirm').addEventListener('click', () => {
            hidePaymentDialog();
            startNewRound();
        });
        
        document.getElementById('payment-cancel').addEventListener('click', () => {
            hidePaymentDialog();
        });
        
        document.getElementById('exit-game-btn').addEventListener('click', exitToLogin);
        
        document.getElementById('export-data-btn').addEventListener('click', exportDataToCSV);
         
        document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            adminPage.classList.remove('active');
            loginPage.classList.add('active');
            
            // æ¸…é™¤è¾“å…¥æ¡†
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('error-message').textContent = '';
        });
        
        // åˆå§‹åŒ–
        window.onload = () => {
            // åˆå§‹åŒ–ä¸€äº›æ¼”ç¤ºæ•°æ®ï¼ˆå®é™…ä½¿ç”¨ä¸­å¯ä»¥ä»æœåŠ¡å™¨åŠ è½½ï¼‰
            gameData.stats.totalFlips = 1250;
            gameData.stats.gamesPlayed = 15;
            gameData.stats.roundsPlayed = 89;
            gameData.stats.earlyExits = 23;
            gameData.stats.bombTriggers = 18;
            
            // æ·»åŠ ä¸€äº›æ¨¡æ‹Ÿçš„ç©å®¶ä¼šè¯æ•°æ®ç”¨äºæ¼”ç¤º
            for (let i = 0; i < 15; i++) {
                gameData.playerSessions.push({
                    startTime: Date.now() - Math.random() * 86400000 * 7, // è¿‡å»ä¸€å‘¨å†…
                    totalRewards: Math.floor(Math.random() * 500) + 50,
                    rounds: Array.from({length: Math.floor(Math.random() * 10) + 1}, (_, j) => ({
                        round: j + 1,
                        flippedCards: Math.floor(Math.random() * 16) + 1,
                        endReason: ['bomb', 'stop', 'win'][Math.floor(Math.random() * 3)]
                    }))
                });
            }
            
            // ç”Ÿæˆä¸€äº›é£é™©ä¼°è®¡æ•°æ®
            for (let i = 0; i < 100; i++) {
                gameData.stats.riskEstimations.push({
                    actualBombProb: Math.random() * 0.5,
                    flippedCount: Math.floor(Math.random() * 16) + 1,
                    round: Math.floor(Math.random() * 10) + 1
                });
            }
        };
    </script>
</body>
</html>